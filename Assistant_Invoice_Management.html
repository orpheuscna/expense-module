<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="asset-version" content="2025-10-15-1" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Invoice Management — Completed Filter & Tags (Demo Payments Seeded)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --blue:#0b5cff; --navy:#08306b; --muted:#6b7280; --bg:#f5f7fb;
    --card:#ffffff; --success:#12b76a; --warn:#f59e0b; --danger:#ef4444;
    --approved-bg:#e6fffa;
    --pending-approval-bg:#eef6ff;
    --changes-requested-bg:#fff7ed;
  }
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
  .wrap{max-width:1200px;margin:28px auto;padding:16px}
  .card{background:var(--card);border-radius:10px;padding:12px;border:1px solid rgba(2,6,23,0.06);box-shadow:0 6px 20px rgba(12,20,40,0.04)}
  h2{margin:0 0 12px 0;color:var(--navy)}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .tool-btn{padding:8px 12px;border-radius:8px;border:1px solid #e6eef6;cursor:pointer;background:#fff;color:var(--navy);font-weight:700}
  .filter{padding:8px;border:1px solid #e6eef6;border-radius:8px;background:#fff}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px 8px;text-align:left;border-bottom:1px solid #f1f5f9;font-size:14px;vertical-align:middle}
  .table th{font-weight:700;color:var(--muted);font-size:12px}
  .status{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px;display:inline-block}
  .s-pending-review{background:#fff7ed;color:#9a5800}
  .s-pending-approval{background:var(--pending-approval-bg);color:#08306b}
  .s-approved-electronic{background:var(--approved-bg);color:#047857}
  .s-approved-physical{background:var(--approved-bg);color:#047857}
  .s-changes-requested{background:var(--changes-requested-bg);color:#9a5800}
  .s-rejected{background:#fff1f2;color:var(--danger)}
  .s-paid{background:#ecfdf5;color:var(--success)}
  .s-to-be-paid{background:#fff7ed;color:var(--navy)}
  .compact{font-size:13px;color:var(--muted)}
  .actions button{margin-left:6px;padding:6px 10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;cursor:pointer}
  .payment-primary{background:linear-gradient(90deg,var(--blue),#6ea8ff);color:#08306b;border:0;padding:6px 10px;border-radius:8px;cursor:pointer}
  .payment-secondary{background:#fff;border:1px solid #e6eef6;color:var(--navy);padding:6px 10px;border-radius:8px;cursor:pointer}
  th.amount,td.amount{width:140px;text-align:right;padding-right:18px}
  th.status,td.status{min-width:140px}
  .detail-panel{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:flex-end;padding:40px;pointer-events:none}
  .detail-card{width:880px;max-width:calc(100% - 48px);pointer-events:auto;background:#fff;border-radius:12px;padding:18px;border:1px solid rgba(2,6,23,0.06);box-shadow:0 30px 60px rgba(2,6,23,0.18);display:grid;grid-template-columns:1fr 360px;gap:18px}
  .detail-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn-primary{background:var(--blue);color:#fff}
  .btn-outline{ background:#fff; border:1px solid #e6eef6; color:var(--navy); text-decoration: none; }
  .field{display:flex;flex-direction:column;margin-bottom:8px}
  .input,.select,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef6;background:#fbfdff;font-family:inherit}
  .attachments{height:360px;background:#f8fafc;border-radius:8px;border:1px dashed #e6eef6;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  .line-items{border-top:1px solid #f1f5f9;margin-top:12px;padding-top:12px}
  .li-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #fbfdff}
  .audit{font-size:13px;color:var(--muted);margin-top:12px}
  .mark-completed { background: #e6f0ff; color: var(--navy); border: 1px solid #cfe0ff; font-weight:700; }
  .tag-picker .btn.btn-primary { background: #fff; color: var(--navy); border: 1px solid #e6eef6; }
  .tag-picker .filter { margin:0; padding:6px 8px; height:36px; }
  .tag-picker .btn { padding:6px 10px; height:36px; }
  @media(max-width:980px){ .detail-card{grid-template-columns:1fr} .attachments{height:220px} }
  .upload-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.35);display:none;align-items:center;justify-content:center;z-index:300}
  .upload-panel{width:720px;max-width:calc(100vw - 32px);background:#fff;border-radius:12px;box-shadow:0 24px 60px rgba(2,6,23,0.3);overflow:hidden;padding:16px}
  .upload-panel .h{font-weight:800}
  .upload-panel .input-file{display:block;width:100%;padding:12px;border:1px dashed #e6eef6;border-radius:8px;background:#fbfdff;cursor:pointer;text-align:center}
  .upload-panel .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .upload-panel .btn-primary{background:var(--blue);color:#fff}
  .upload-neutral{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:1px solid #e6eef6;background:#fff;color:var(--navy);font-weight:700;cursor:pointer;text-decoration:none;}
  .action-btn{background:#f3f4f6;border-radius:8px;padding:6px 10px;border:1px solid #e6eef6;cursor:pointer}
  .progress-bar{transition:width .3s linear}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:600}
  .modal{width:680px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(2,6,23,0.3);max-width:92vw;min-width:320px;box-sizing:border-box;position:relative}
  .split-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .split-row .small { font-size:12px;color:var(--muted) }
  .split-row input, .split-row select{padding:6px;border-radius:6px;border:1px solid #e6eef6}
  .split-amount{flex:0 0 110px;min-width:90px}
  .split-date{flex:0 0 130px;min-width:110px}
  .split-method{flex:0 0 140px;min-width:110px}
  .split-type{flex:0 0 140px;min-width:110px}
  .split-ref{flex:1 1 120px;min-width:80px}
  .split-actions{width:60px;text-align:center}
  .muted-inline{font-size:13px;color:var(--muted);margin-top:6px}
  @media (max-width:540px){
    .split-row input, .split-row select{ padding:6px 6px; font-size:13px; }
    .split-amount{ flex-basis:95px; }
  }
  .hidden{display:none}
</style>
<!-- SheetJS for XLSX export -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div><h2>Invoice Management</h2></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="newUpload" class="tool-btn">New Upload</button>
      <button id="bulkUpload" class="tool-btn">Bulk Upload</button>
      <button id="scanUpload" class="tool-btn">Scan to Upload</button>
    </div>
  </div>

  <div class="card">
    <div class="toolbar" id="toolbarArea">
      <input id="q" class="filter" placeholder="Search by vendor, invoice #, amount or tag" style="width:260px" />
      <label class="compact">From</label><input id="dateFrom" type="date" class="filter" />
      <label class="compact">To</label><input id="dateTo" type="date" class="filter" />
      <select id="categoryFilter" class="filter">
        <option value="">All categories</option><option>Office Supplies</option><option>Travel</option><option>Rent</option><option>Entertainment</option><option>Consulting</option><option>Logistics</option><option>Maintenance</option>
      </select>

      <select id="statusFilter" class="filter">
        <option value="">All statuses</option>
        <option value="pending_review">Pending Review</option>
        <option value="pending_approval">Pending Approval</option>
        <option value="approved_electronic">Approved (Electronic)</option>
        <option value="approved_physical">Approved (Physical)</option>
        <option value="changes_requested">Changes Requested</option>
        <option value="rejected">Rejected</option>
      </select>

      <div id="showCompletedWrap" style="display:flex;align-items:center;gap:8px;margin-left:8px">
        <label class="compact">Show completed</label>
        <input id="showCompleted" type="checkbox" class="filter" />
      </div>

      <div style="flex:1"></div>
    </div>

    <table class="table" id="inboxTable" aria-label="Invoice management">
      <thead>
        <tr>
          <th scope="col" style="width:36px"><input id="selectAll" type="checkbox" /></th>
          <th scope="col">Vendor</th>
          <th scope="col">Invoice #</th>
          <th scope="col">Date</th>
          <th scope="col" class="amount">Amount</th>
          <th scope="col" class="status">Status</th>
          <th scope="col" style="width:260px">Actions</th>
        </tr>
      </thead>
      <tbody id="inboxBody"></tbody>
    </table>
  </div>
  </div>

<div class="wrap" style="margin-top:18px">
  <div class="card">
    <h3 style="margin:0 0 12px 0;color:var(--navy)">Export Payments</h3>
    <div class="toolbar" style="gap:12px">
     <label class="compact">Export type:</label>
  <select id="exportType" class="filter">
    <option value="all">All payment records</option>
    <option value="vendors">Vendor payments only</option>
    <option value="reimbursements">Employee reimbursements only</option>
  </select>

  <button id="exportCsvBtn" class="btn btn-primary">Export CSV</button>
  <button id="exportXlsxBtn" class="btn btn-outline">Download XLSX</button>

  <div style="flex:1"></div>
  <div class="muted-inline" style="margin-top:8px">Exported data will download as CSV or XLSX and include employee columns.</div>
</div>
  </div>
</div>

<!-- Detail panel (unchanged) -->
<div id="detailPanel" class="detail-panel" role="dialog" aria-modal="true" style="display:none">
  <div class="detail-card card" role="document">
    <div>
      <div class="detail-header">
        <button id="backToInbox" class="btn btn-outline">← Back to list</button>
        <div style="flex:1"></div>
        <div id="detailId" class="compact" style="color:var(--muted)"></div>
      </div>
      <div style="font-weight:700;margin-top:12px">History</div>
      <div id="historyList"></div>
    </div>
    <div style="width:360px">
      <div style="font-weight:700;margin-bottom:8px">Extracted data</div>
      <div class="field"><label class="compact">PO</label><input id="dPO" class="input" /></div>
      <div class="field"><label class="compact">Tax</label><input id="dTax" class="input" /></div>
    </div>
  </div>
</div>

<!-- Upload panel simplified -->
<div id="uploadBackdrop" class="upload-backdrop" aria-hidden="true" style="display:none">
  <div id="uploadPanel" class="upload-panel" role="dialog" aria-modal="true" aria-labelledby="uploadPanelTitle" style="background:#fff;padding:16px;border-radius:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div><div id="uploadPanelTitle" class="h">Upload</div><div id="uploadPanelSubtitle" class="compact" style="color:var(--muted)">Select files to upload</div></div>
      <div><button id="closeUploadPanel" class="btn btn-outline">✕</button></div>
    </div>
    <label class="input-file" id="panelFileLabel" style="display:block;padding:12px;border:1px dashed #e6eef6;border-radius:8px;background:#fbfdff;text-align:center;cursor:pointer">Click to choose files
      <input id="panelFileInput" type="file" accept=".pdf,image/*" multiple style="display:none" />
    </label>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="panelCancel" class="btn btn-outline">Cancel</button>
      <button id="panelUpload" class="btn btn-primary">Upload</button>
    </div>
    <div style="margin-top:16px;border-top:1px solid #f1f5f9;padding-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Upload Status & Progress</strong><div class="small" style="margin-top:4px;color:var(--muted)">Recent uploads and OCR progress</div></div>
        <div style="display:flex;gap:8px;align-items:center"><button id="clearUploadList" class="upload-neutral" style="font-weight:600;padding:6px 10px">Clear</button></div>
      </div>
      <div id="uploadList" style="margin-top:12px;display:flex;flex-direction:column;gap:12px">
        <div class="small-muted" style="padding:12px">No recent uploads</div>
      </div>
    </div>
  </div>
</div>

<!-- Payment modal backdrop centered -->
<div id="paymentModalBackdrop" class="modal-backdrop" aria-hidden="true" style="display:none;align-items:center;justify-content:center">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="paymentModalTitle">
    <div style="font-weight:700;margin-bottom:8px" id="paymentModalTitle">Settle invoice</div>

    <div id="paymentModalBody">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <label style="margin:0;font-weight:600">Mode</label>
        <label class="compact" style="margin:0 6px"><input id="singleMode" type="radio" name="payMode" checked /> Single</label>
        <label class="compact" style="margin:0 6px"><input id="splitMode" type="radio" name="payMode" /> Split</label>
      </div>

      <!-- Single payment area -->
      <div id="singlePaymentArea">
        <div class="field">
          <label class="compact">Type</label>
          <select id="payType" class="filter">
            <option value="pay">Pay vendor</option>
            <option value="reimburse">Reimburse employee</option>
          </select>
        </div>

        <div class="field hidden" id="employeeFields">
          <label class="compact">Employee ID</label>
          <input id="payEmployeeId" class="input" />
          <label class="compact" style="margin-top:8px">Employee name</label>
          <input id="payEmployeeName" class="input" />
        </div>

        <div class="field">
          <label class="compact">Amount</label>
          <input id="payAmount" class="input" type="number" step="0.01" min="0" />
          <div id="payRemaining" class="compact" style="margin-top:6px;color:var(--muted)"></div>
        </div>

        <div class="field">
          <label class="compact">Payment date</label>
          <input id="payDate" class="input" type="date" />
        </div>

        <div class="field">
          <label class="compact">Method</label>
          <select id="payMethod" class="filter">
            <option>Bank transfer</option>
            <option>Cash</option>
            <option>Card</option>
            <option>Other</option>
          </select>
        </div>

        <div class="field">
          <label class="compact">Reference</label>
          <input id="payRef" class="input" />
        </div>

        <div class="field">
          <label class="compact">Note</label>
          <textarea id="payNote" class="input" rows="3"></textarea>
        </div>

        <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
          <input id="schedulePayment" type="checkbox" />
          <label for="schedulePayment" class="compact" style="margin:0">Schedule payment (do not record now)</label>
        </div>
      </div>

      <!-- Split payment area -->
      <div id="splitPaymentArea" style="display:none">
        <div id="splitRows"></div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button id="addSplitRow" class="btn btn-outline" type="button">Add split line</button>
          <div class="muted-inline">Each line will create a separate payment record</div>
        </div>
        <div class="muted-inline" id="splitSummary" style="margin-top:10px"></div>

        <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <input id="scheduleSplit" type="checkbox" />
          <label for="scheduleSplit" class="compact" style="margin:0">Schedule split payments (do not record now)</label>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="payModalCancel" class="btn btn-outline">Cancel</button>
      <button id="payModalConfirm" class="btn btn-primary">Confirm payment</button>
    </div>
  </div>
</div>

<script>
/* Full invoice dataset */
let invoices = [
  { id:'inv-001', vendor:'ACME Supplies', number:'INV-1001', date:'2025-09-28', amount:1250.00, status:'pending_review', category:'Office Supplies', items:[{desc:'Paper',qty:10,price:12.5}], history:['Submitted by assistant • 2h ago'], directorAction:null, attachments:[] },
  { id:'inv-002', vendor:'Travel Co', number:'INV-1002', date:'2025-09-20', amount:420.00, status:'approved_electronic', category:'Travel', items:[{desc:'Taxi',qty:1,price:120},{desc:'Hotel',qty:1,price:300}], history:['Uploaded • Yesterday','Director approved electronically • 2025-10-02 09:15'], directorAction:{type:'approved_electronic',note:'Approved for payment',time:'2025-10-02 09:15'}, attachments:[], completionTag:'Sent to TRG', archivedCompleted:false },
  { id:'inv-003', vendor:'OfficeMax', number:'INV-1003', date:'2025-09-12', amount:210.00, status:'pending_approval', category:'Office Supplies', items:[{desc:'Staples',qty:5,price:42}], history:['Ready'], directorAction:null, attachments:[] },
  { id:'inv-004', vendor:'Catering Ltd', number:'INV-1004', date:'2025-10-01', amount:980.00, status:'rejected', category:'Entertainment', items:[{desc:'Lunch',qty:1,price:980}], history:['Rejected by reviewer • 1d ago'], directorAction:{type:'rejected',note:'Not eligible',time:'2025-10-02 09:00'}, attachments:[] },
  { id:'inv-005', vendor:'Consulting LLC', number:'INV-1005', date:'2025-09-30', amount:3400.00, status:'approved_physical', category:'Consulting', items:[{desc:'Consulting fee',qty:1,price:3400}], history:['Submitted','Director approved (will sign physically) • 2025-10-02 10:30'], directorAction:{type:'approved_physical',note:'Will sign in person',time:'2025-10-02 10:30'}, attachments:[], completionTag:'Will be reimbursed on payday', archivedCompleted:false },
  { id:'inv-009', vendor:'Vendor A', number:'INV-2001', date:'2025-08-11', amount:500.00, status:'approved_electronic', category:'Office Supplies', items:[{desc:'Ink',qty:5,price:100}], history:['Director approved electronically • 2025-08-15','Assistant marked completed: Sent to TRG • 2025-08-16'], directorAction:{type:'approved_electronic',note:'OK'}, attachments:[], completionTag:'Sent to TRG', archivedCompleted:true },
  { id:'inv-010', vendor:'Vendor B', number:'INV-2002', date:'2025-07-20', amount:120.00, status:'approved_physical', category:'Travel', items:[{desc:'Taxi',qty:1,price:120}], history:['Director approved (physical) • 2025-07-25','Assistant marked completed: Transfer on Payday • 2025-07-26'], directorAction:{type:'approved_physical',note:'Will sign'}, attachments:[], completionTag:'Will be reimbursed on payday', archivedCompleted:true },
  { id:'inv-011', vendor:'Vendor C', number:'INV-2003', date:'2025-06-05', amount:60.00, status:'approved_electronic', category:'Office Supplies', items:[{desc:'Staples',qty:3,price:20}], history:['Director approved electronically • 2025-06-10','Assistant marked completed: Will pay in cash • 2025-06-11'], directorAction:{type:'approved_electronic',note:'Approved'}, attachments:[], completionTag:'Will pay in cash', archivedCompleted:true },
  { id:'inv-006', vendor:'Logistics Inc', number:'INV-1006', date:'2025-09-25', amount:1500.00, status:'pending_approval', category:'Logistics', items:[{desc:'Freight',qty:1,price:1500}], history:['Submitted'], directorAction:null, attachments:[] },
  { id:'inv-007', vendor:'Stationery Co', number:'INV-1007', date:'2025-10-02', amount:75.00, status:'changes_requested', category:'Office Supplies', items:[{desc:'Pens',qty:15,price:5}], history:['Uploaded • 1h ago','Director requested changes • 2025-10-02 11:00'], directorAction:{type:'changes_requested',note:'Please correct vendor code',time:'2025-10-02 11:00'}, attachments:[] },
  { id:'inv-008', vendor:'Maintenance Co', number:'INV-1008', date:'2025-10-03', amount:620.00, status:'pending_review', category:'Maintenance', items:[{desc:'Repair',qty:1,price:620}], history:['Submitted • 30m ago'], directorAction:null, attachments:[] }
];

/* Option B: seed demo paymentRecords so exports contain data */
(function seedDemoPayments(){
  const demoMap = {
    'inv-009': [{ type:'pay', amount:250.00, method:'Bank transfer', ref:'TR-900', date:'2025-08-16', vendorName:'Vendor A' }],
    'inv-010': [{ type:'reimburse', amount:60.00, method:'Cash', ref:'CASH-331', date:'2025-07-26', vendorName:'Vendor B', employeeId:'E-9001', employeeName:'Tran Duc H' }],
    'inv-002': [{ type:'pay', amount:420.00, method:'Bank transfer', ref:'TR-420', date:'2025-09-21', vendorName:'Travel Co' }]
  };
  invoices.forEach(inv => {
    if(demoMap[inv.id]){
      inv.paymentRecords = inv.paymentRecords || [];
      demoMap[inv.id].forEach(p => inv.paymentRecords.push(Object.assign({}, p)));
      // set balanceRemaining if not present or recompute
      const paid = inv.paymentRecords.reduce((s,r)=> s + (Number(r.amount) || 0), 0);
      inv.balanceRemaining = Math.max(0, Number(inv.amount || 0) - paid);
    }
  });
})();

const getById = id => document.getElementById(id);

function statusClass(s){
  if(s==='pending_review') return 's-pending-review';
  if(s==='pending_approval') return 's-pending-approval';
  if(s==='approved_electronic') return 's-approved-electronic';
  if(s==='approved_physical') return 's-approved-physical';
  if(s==='changes_requested') return 's-changes-requested';
  if(s==='rejected') return 's-rejected';
  return 's-pending-review';
}
function statusLabel(s){
  if(s==='pending_review') return 'Pending Review';
  if(s==='pending_approval') return 'Pending Approval';
  if(s==='approved_electronic') return 'Approved (Electronic)';
  if(s==='approved_physical') return 'Approved (Physical)';
  if(s==='changes_requested') return 'Changes Requested';
  if(s==='rejected') return 'Rejected';
  return s;
}
function inDateRange(invDateISO, fromISO, toISO){
  if(!fromISO && !toISO) return true;
  const invD = new Date(invDateISO + 'T00:00:00');
  if(fromISO){ const fromD = new Date(fromISO + 'T00:00:00'); if(invD < fromD) return false; }
  if(toISO){ const toD = new Date(toISO + 'T23:59:59'); if(invD > toD) return false; }
  return true;
}

/* Render inbox */
function renderInbox(){
  const tbody = getById('inboxBody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const q = (getById('q') && getById('q').value.toLowerCase()) || '';
  const st = getById('statusFilter') ? getById('statusFilter').value : '';
  const cat = getById('categoryFilter') ? getById('categoryFilter').value : '';
  const from = getById('dateFrom') ? getById('dateFrom').value : '';
  const to = getById('dateTo') ? getById('dateTo').value : '';
  const showCompleted = getById('showCompleted') ? getById('showCompleted').checked : false;
  const tagFilter = getById('completionTagFilter') ? (getById('completionTagFilter').value || '').trim() : '';

  invoices.forEach(inv => {
    if(typeof inv.balanceRemaining === 'undefined') inv.balanceRemaining = Number(inv.amount || 0);
    if(typeof inv.paymentRecords === 'undefined') inv.paymentRecords = [];
    if(typeof inv.scheduledPayments === 'undefined') inv.scheduledPayments = [];

    if(showCompleted){
      if(!inv.archivedCompleted) return;
    } else {
      if(inv.archivedCompleted) return;
    }

    if (st && inv.status !== st) return;
    if (cat && cat !== '' && inv.category !== cat) return;
    if (!inDateRange(inv.date, from, to)) return;

    if (q){
      const matches = (inv.vendor || '').toLowerCase().includes(q) ||
                      (inv.number || '').toLowerCase().includes(q) ||
                      String(inv.amount).includes(q) ||
                      ((inv.completionTag||'').toLowerCase().includes(q));
      if(!matches) return;
    }

    if (tagFilter){
      if ((inv.completionTag||'') !== tagFilter) return;
    }

    const tr = document.createElement('tr');
    tr.dataset.id = inv.id;

    const tdCheck = document.createElement('td'); const chk = document.createElement('input'); chk.type = 'checkbox'; chk.dataset.id = inv.id; tdCheck.appendChild(chk); tr.appendChild(tdCheck);
    const tdVendor = document.createElement('td'); tdVendor.textContent = inv.vendor || ''; tr.appendChild(tdVendor);
    const tdNumber = document.createElement('td'); tdNumber.textContent = inv.number || ''; tr.appendChild(tdNumber);
    const tdDate = document.createElement('td'); tdDate.textContent = inv.date || ''; tr.appendChild(tdDate);
    const tdAmount = document.createElement('td'); tdAmount.className = 'amount'; tdAmount.textContent = '$' + (Number(inv.amount || 0)).toFixed(2); tr.appendChild(tdAmount);

    const tdStatus = document.createElement('td'); tdStatus.className = 'status';
    const span = document.createElement('span');
    if(inv.archivedCompleted){
      if(inv.balanceRemaining <= 0){
        span.className = 'status s-paid'; span.textContent = 'Paid';
      } else {
        span.className = 'status s-to-be-paid'; span.textContent = 'Completed (unsettled)';
      }
    } else {
      span.className = 'status ' + statusClass(inv.status); span.textContent = statusLabel(inv.status);
    }
    tdStatus.appendChild(span); tr.appendChild(tdStatus);

    const tdActions = document.createElement('td'); tdActions.className = 'compact actions';

    if(inv.archivedCompleted){
      if(inv.balanceRemaining > 0){
        const btnOpen = document.createElement('button'); btnOpen.className = 'btn btn-outline'; btnOpen.type = 'button'; btnOpen.textContent = 'Open';
        btnOpen.addEventListener('click', ()=> {
          window.location.href = 'Assistant_View_Approved_Invoice.html?id=' + encodeURIComponent(inv.id);
        });
        tdActions.appendChild(btnOpen);

        if(inv.employeeExpense){
          const btnReimb = document.createElement('button'); btnReimb.className='payment-primary'; btnReimb.type='button'; btnReimb.dataset.id=inv.id; btnReimb.textContent='Reimburse employee';
          btnReimb.addEventListener('click', (e)=> openSettleModal(inv.id,'reimburse'));
          tdActions.appendChild(btnReimb);
        } else {
          const btnPay = document.createElement('button'); btnPay.className='payment-primary'; btnPay.type='button'; btnPay.dataset.id=inv.id; btnPay.textContent='Pay';
          btnPay.addEventListener('click', (e)=> openSettleModal(inv.id,'pay'));
          tdActions.appendChild(btnPay);
        }
      } else {
        const done = document.createElement('div'); done.className='compact'; done.textContent = 'Settled';
        tdActions.appendChild(done);
      }
    } else {
      const aOpen = document.createElement('a');
      aOpen.className = 'btn btn-outline open';
      let linkUrl = '';
      if (inv.status === 'pending_review' || inv.status === 'pending_approval') {
          linkUrl = 'Assistant_View_Invoice.html?id=' + inv.id;
      } else if (
          inv.status === 'approved_electronic' ||
          inv.status === 'approved_physical' ||
          inv.status === 'rejected'
      ) {
          linkUrl = 'Assistant_View_Approved_Invoice.html?id=' + inv.id;
      } else if (inv.status === 'changes_requested') {
          linkUrl = 'Assistant_View_Changed_Invoice.html?id=' + inv.id;
      } else {
          linkUrl = '#';
      }
      aOpen.href = linkUrl;
      aOpen.textContent = 'Open';
      tdActions.appendChild(aOpen);

      if(inv.status === 'pending_review'){
        const btnSubmit = document.createElement('button'); btnSubmit.className='btn btn-outline submit'; btnSubmit.type='button'; btnSubmit.dataset.id=inv.id; btnSubmit.textContent='Submit'; tdActions.appendChild(btnSubmit);
      }

      if(inv.status === 'changes_requested'){
        const btnResubmit = document.createElement('button'); btnResubmit.className='btn btn-outline resubmit-row'; btnResubmit.type='button'; btnResubmit.dataset.id=inv.id; btnResubmit.textContent='Resubmit'; tdActions.appendChild(btnResubmit);
      }

      if(inv.status === 'pending_review'){
        const btnDelete = document.createElement('button'); btnDelete.className='btn btn-outline delete'; btnDelete.type='button'; btnDelete.dataset.id = inv.id;
        btnDelete.style.color='var(--danger)'; btnDelete.style.borderColor='#fee2e2'; btnDelete.textContent='Delete'; tdActions.appendChild(btnDelete);
      }

      if((inv.status === 'approved_electronic' || inv.status === 'approved_physical' || inv.status === 'rejected') && !getById('showCompleted').checked){
        const btnCompleted = document.createElement('button'); btnCompleted.className='btn mark-completed'; btnCompleted.type='button'; btnCompleted.dataset.id=inv.id; btnCompleted.textContent='Mark as Completed';
        tdActions.appendChild(btnCompleted);
      }
    }

    tr.appendChild(tdActions);
    tbody.appendChild(tr);
  });
}

/* Inline picker and completion-tag injection */
function showInlineTagPicker(anchorBtn, invId){
  const existing = anchorBtn.parentElement.querySelector('.tag-picker');
  if(existing) return;

  const picker = document.createElement('span');
  picker.className = 'tag-picker';

  const sel = document.createElement('select');
  sel.className = 'filter';
  sel.innerHTML = '<option value="">Choose tag (optional)</option><option>Sent to TRG</option><option>Will be reimbursed on payday</option><option>Will pay in cash</option><option>Rejected</option>';

  const applyBtn = document.createElement('button');
  applyBtn.className = 'btn btn-primary';
  applyBtn.type = 'button';
  applyBtn.textContent = 'Apply';

  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn btn-outline';
  cancelBtn.type = 'button';
  cancelBtn.textContent = 'Cancel';

  picker.appendChild(sel);
  picker.appendChild(applyBtn);
  picker.appendChild(cancelBtn);

  anchorBtn.parentElement.appendChild(picker);

  setTimeout(()=> sel.focus(), 50);

  function removePicker(){
    if(picker && picker.parentElement) picker.remove();
  }

  applyBtn.addEventListener('click', () => {
    const tag = sel.value || '';
    const inv = invoices.find(i => i.id === invId);
    if(!inv) { removePicker(); return; }
    inv.completionTag = tag;
    inv.history = (inv.history||[]).concat([`Assistant marked completed${tag?': '+tag:''} • ${new Date().toLocaleString()}`]);
    inv.archivedCompleted = true;
    removePicker();
    renderInbox();
    alert('Marked completed (demo).');
  });

  cancelBtn.addEventListener('click', () => {
    removePicker();
  });

  function onDocClick(e){
    if(!picker.contains(e.target) && e.target !== anchorBtn){
      removePicker();
      document.removeEventListener('click', onDocClick);
    }
  }
  setTimeout(()=> document.addEventListener('click', onDocClick), 50);
}

function createCompletionTagSelect() {
  const sel = document.createElement('select');
  sel.id = 'completionTagFilter';
  sel.className = 'filter';
  sel.style.maxWidth = '200px';
  sel.innerHTML = '<option value="">Any completion tag</option>'
                + '<option>Sent to TRG</option>'
                + '<option>Will be reimbursed on payday</option>'
                + '<option>Will pay in cash</option>'
                + '<option>Rejected</option>';
  sel.addEventListener('input', () => renderInbox());
  return sel;
}
function removeInjectedCompletionTagSelect() {
  const existing = document.getElementById('completionTagFilter');
  if (existing && existing.parentElement && existing.parentElement.id === 'showCompletedWrap') {
    existing.remove();
  }
}

/* IMPORTANT: define closeDetail so listeners that reference it won't error */
function closeDetail(){ 
  const panel = getById('detailPanel');
  if(panel) panel.style.display = 'none';
}

/* DOM ready wiring */
document.addEventListener('DOMContentLoaded', function(){
  const showWrap = document.getElementById('showCompletedWrap');
  const sc = document.getElementById('showCompleted');

  removeInjectedCompletionTagSelect();

  function toggleInlineTagSelect() {
    removeInjectedCompletionTagSelect();
    if (sc.checked) {
      const sel = createCompletionTagSelect();
      showWrap.appendChild(sel);
      setTimeout(()=>sel.focus(),100);
    }
    renderInbox();
  }

  sc.addEventListener('change', toggleInlineTagSelect);
  sc.addEventListener('input', toggleInlineTagSelect);
  toggleInlineTagSelect();

  ['q','statusFilter','categoryFilter','dateFrom','dateTo'].forEach(id=>{
    const el = getById(id); if(el) el.addEventListener('input', ()=> renderInbox());
  });

  // wire upload controls
  const newUpload = getById('newUpload'); if(newUpload) newUpload.addEventListener('click', ()=> openUploadPanel('single'));
  const bulkUpload = getById('bulkUpload'); if(bulkUpload) bulkUpload.addEventListener('click', ()=> openUploadPanel('bulk'));
  const scanUpload = getById('scanUpload'); if(scanUpload) scanUpload.addEventListener('click', ()=> openUploadPanel('scan'));
  const closeUpload = getById('closeUploadPanel'); if(closeUpload) closeUpload.addEventListener('click', ()=> closeUploadPanel());
  const panelCancel = getById('panelCancel'); if(panelCancel) panelCancel.addEventListener('click', ()=> closeUploadPanel());
  const panelFileLabel = getById('panelFileLabel'); if(panelFileLabel) panelFileLabel.addEventListener('click', ()=> { const f = getById('panelFileInput'); if(f) f.click(); });

  renderInbox();
});

/* delegated inbox actions */
getById('inboxBody').addEventListener('click', (e)=>{
  const openBtn = e.target.closest('.open'); if(openBtn){ return; }
  const submitBtn = e.target.closest('.submit'); if(submitBtn){
    const id = submitBtn.dataset.id; const inv = invoices.find(i=>i.id===id); if(!inv) return;
    if(inv.status === 'pending_review'){ inv.status='pending_approval'; inv.history=(inv.history||[]).concat([`Submitted to Director • ${new Date().toLocaleString()}`]); renderInbox(); alert(`Submitted ${inv.number} to Director (demo).`);} else alert('Submit ignored');
    return;
  }
  const resubmitRow = e.target.closest('.resubmit-row'); if(resubmitRow){
    const id = resubmitRow.dataset.id; const inv=invoices.find(i=>i.id===id); if(!inv) return;
    if(inv.status==='changes_requested'){ const note = prompt('Resubmission note (demo)','Corrected'); inv.history=(inv.history||[]).concat([`Resubmitted • ${new Date().toLocaleString()} • ${note}`]); inv.status='pending_approval'; renderInbox(); alert('Resubmitted (demo).');}
    return;
  }
  const deleteBtn = e.target.closest('.delete'); if(deleteBtn){
    const id = deleteBtn.dataset.id; const inv=invoices.find(i=>i.id===id); if(!inv) return; if(inv.status!=='pending_review'){ alert('Cannot delete'); return; } if(!confirm(`Delete ${inv.number}?`)) return; invoices=invoices.filter(i=>i.id!==id); renderInbox(); return;
  }
  const completedBtn = e.target.closest('.mark-completed'); if(completedBtn){
    const id = completedBtn.dataset.id; const inv=invoices.find(i=>i.id===id); if(!inv) return;
    if(inv.status === 'rejected'){
      inv.completionTag = 'Rejected';
      inv.history=(inv.history||[]).concat([`Assistant marked completed: Rejected • ${new Date().toLocaleString()}`]);
      inv.archivedCompleted = true;
      renderInbox();
      alert('Marked rejected invoice as completed with tag "Rejected" (demo).');
      return;
    }
    if(inv.status==='approved_electronic' || inv.status==='approved_physical'){
      showInlineTagPicker(completedBtn, id);
      return;
    }
    alert('Mark as Completed available only for approved or rejected invoices');
    return;
  }
});

/* upload panel functions */
function openUploadPanel(mode){
  const b = getById('uploadBackdrop');
  if(!b) return;
  b.style.display = 'flex';
  b.setAttribute('aria-hidden','false');
  const title = getById('uploadPanelTitle');
  const sub = getById('uploadPanelSubtitle');
  if(title) {
    if(mode === 'scan') title.textContent = 'Scan to Upload';
    else title.textContent = mode === 'single' ? 'Upload' : mode === 'bulk' ? 'Bulk upload' : 'Upload';
  }
  if(sub) {
    if(mode === 'scan') sub.textContent = 'Use your desktop scanner software to scan the document. Then upload the scanned file below.';
    else sub.textContent = mode === 'single' ? 'Select files to upload' : mode === 'bulk' ? 'Select multiple files to upload' : 'Select files to upload';
  }
}
function closeUploadPanel(){
  const b = getById('uploadBackdrop');
  if(!b) return;
  b.style.display = 'none';
  b.setAttribute('aria-hidden','true');
}
getById('clearUploadList').addEventListener('click', ()=> {
  const list = document.getElementById('uploadList');
  if(list) list.innerHTML = '<div class="small-muted" style="padding:12px">No recent uploads</div>';
});
getById('panelUpload').addEventListener('click', ()=> {
  const files = getById('panelFileInput').files;
  if(!files || files.length === 0){ alert('Choose files (demo)'); return; }
  alert('Upload simulated (demo).');
  closeUploadPanel();
});

/* PAYMENT functionality with Employee fields in single and split; modal centered by default */
let _currentSettle = null;

function openSettleModal(invId, mode){
  const inv = invoices.find(i=>i.id===invId);
  if(!inv) return;
  _currentSettle = { id: invId, mode };
  const remaining = Number(inv.balanceRemaining || inv.amount || 0);

  // default UI
  const singleMode = getById('singleMode'); if(singleMode) singleMode.checked = true;
  const splitMode = getById('splitMode'); if(splitMode) splitMode.checked = false;
  if(getById('splitPaymentArea')) getById('splitPaymentArea').style.display = 'none';
  if(getById('singlePaymentArea')) getById('singlePaymentArea').style.display = 'block';

  // Prefill amount and type
  if(getById('payAmount')) getById('payAmount').value = remaining.toFixed(2);
  if(getById('payType')) getById('payType').value = (mode === 'reimburse') ? 'reimburse' : (inv.employeeExpense ? 'reimburse' : 'pay');

  // Show/hide employee fields for single payment
  const empFields = getById('employeeFields');
  if(empFields){
    if(getById('payType').value === 'reimburse') empFields.classList.remove('hidden'); else empFields.classList.add('hidden');
  }

  if(getById('payRemaining')) getById('payRemaining').textContent = 'Remaining balance: $' + remaining.toFixed(2);
  if(getById('payDate')) getById('payDate').value = new Date().toISOString().slice(0,10);
  if(getById('payMethod')) getById('payMethod').value = 'Bank transfer';
  if(getById('payRef')) getById('payRef').value = '';
  if(getById('payNote')) getById('payNote').value = '';
  if(getById('schedulePayment')) getById('schedulePayment').checked = false;
  if(getById('scheduleSplit')) getById('scheduleSplit').checked = false;

  // clear split rows (split rows include employee fields per line)
  const splitRowsEl = getById('splitRows'); if(splitRowsEl) splitRowsEl.innerHTML = '';
  if(getById('splitSummary')) getById('splitSummary').textContent = '';

  // show centered modal (backdrop uses flex center)
  const backdrop = getById('paymentModalBackdrop');
  if(!backdrop) return;
  backdrop.style.display = 'flex';
  backdrop.setAttribute('aria-hidden','false');
  const modal = backdrop.querySelector('.modal');
  if(modal){
    modal.style.position = 'relative';
    modal.style.left = '';
    modal.style.top = '';
    modal.style.transform = 'none';
  }
}

function closePaymentModal(){ 
  const b = getById('paymentModalBackdrop'); 
  if(!b) return;
  b.style.display = 'none';
  b.setAttribute('aria-hidden','true');
  _currentSettle = null;
}

/* rest of existing logic unchanged... (pay modal handlers and export wiring below) */

/* pay amount remaining calc */
getById('payAmount').addEventListener('input', ()=> {
  if(!_currentSettle) return;
  const inv = invoices.find(i=>i.id===_currentSettle.id);
  if(!inv) return;
  const typed = Number(getById('payAmount').value || 0);
  const max = Number(inv.balanceRemaining || inv.amount || 0);
  const remaining = Math.max(0, (max - (isNaN(typed)?0:typed)));
  if(getById('payRemaining')) getById('payRemaining').textContent = 'Remaining after this payment: $' + remaining.toFixed(2);
});

/* Toggle employee fields visibility for single payment */
getById('payType').addEventListener('change', ()=> {
  const t = getById('payType').value;
  const employeeFields = getById('employeeFields');
  if (t === 'reimburse') {
    if(employeeFields) employeeFields.classList.remove('hidden');
    if(getById('payModalConfirm')) getById('payModalConfirm').textContent = 'Confirm reimbursement';
  } else {
    if(employeeFields) employeeFields.classList.add('hidden');
    if(getById('payModalConfirm')) getById('payModalConfirm').textContent = 'Confirm payment';
  }
});

/* utilities */
function escapeHtml(s){ return String(s||'').replace(/[&<>"'`=\/]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60','=':'&#x3D;'})[ch]);}

/* init */
renderInbox();

/* auto-update split summary while modal open */
setInterval(()=> {
  const pb = getById('paymentModalBackdrop');
  if(pb && pb.style.display === 'flex') updateSplitSummary();
}, 800);

/* --- CSV / XLSX export helpers and wiring (clean insertion) --- */
(function(){
  const EXPORT_COLUMNS = [
    { key: 'invoiceId', header: 'Invoice ID' },
    { key: 'invoiceNumber', header: 'Invoice Number' },
    { key: 'invoiceDate', header: 'Invoice Date' },
    { key: 'invoiceAmount', header: 'Invoice Amount' },
    { key: 'balanceRemaining', header: 'Balance Remaining' },
    { key: 'paymentType', header: 'Payment Type' },
    { key: 'amount', header: 'Amount' },
    { key: 'method', header: 'Method' },
    { key: 'ref', header: 'Reference' },
    { key: 'paymentDate', header: 'Payment Date' },
    { key: 'vendorName', header: 'Vendor Name' },
    { key: 'employeeId', header: 'Employee ID' },
    { key: 'employeeName', header: 'Employee Name' }
  ];

  function buildExportRows(){
    const rows = [];
    (invoices || []).forEach(inv => {
      (inv.paymentRecords || []).forEach(p => {
        rows.push({
          invoiceId: inv.id || '',
          invoiceNumber: inv.number || '',
          invoiceDate: inv.date || '',
          invoiceAmount: inv.amount || 0,
          balanceRemaining: inv.balanceRemaining || 0,
          paymentType: p.type || '',
          amount: p.amount || 0,
          method: p.method || '',
          ref: p.ref || '',
          paymentDate: p.date || '',
          vendorName: p.vendor || '',
          employeeId: p.employeeId || '',
          employeeName: p.employeeName || ''
        });
      });
    });
    return rows;
  }

  function toCsv(rows, columns){
    const escapeCell = val => {
      if (val === null || typeof val === 'undefined') return '';
      const s = String(val);
      if (s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    };
    const header = columns.map(c => escapeCell(c.header)).join(',');
    const lines = rows.map(r => columns.map(c => escapeCell(r[c.key])).join(','));
    return [header].concat(lines).join('\r\n');
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 5000);
  }

  function downloadCsv(text, filename){
    const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
    downloadBlob(blob, filename);
  }

  function downloadXlsx(rows, columns, filename){
    // convert rows to objects with header labels as keys
    const sheetRows = rows.map(r => {
      const out = {};
      columns.forEach(c => out[c.header] = r[c.key]);
      return out;
    });
    const ws = XLSX.utils.json_to_sheet(sheetRows, { skipHeader: false });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Payments');
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    downloadBlob(blob, filename);
  }

  function wireExportButtons(){
    const csvBtn = document.getElementById('exportCsvBtn');
    const xlsxBtn = document.getElementById('exportXlsxBtn');
    const getType = ()=> (document.getElementById('exportType') || {}).value || 'all';

    function makeFilename(ext){
      const now = new Date(); const pad = n => String(n).padStart(2,'0');
      return `payments-export-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.${ext}`;
    }

    function onExport(isXlsx){
      const type = getType();
      const all = buildExportRows();
      let filtered = all;
      if (type === 'vendors') filtered = all.filter(r => r.paymentType === 'pay');
      if (type === 'reimbursements') filtered = all.filter(r => r.paymentType === 'reimburse');
      if (!filtered.length) { alert('No records to export for the selected filter.'); return; }

      if (isXlsx) {
        downloadXlsx(filtered, EXPORT_COLUMNS, makeFilename('xlsx'));
      } else {
        const csv = toCsv(filtered, EXPORT_COLUMNS);
        downloadCsv(csv, makeFilename('csv'));
      }
    }

    if (csvBtn) csvBtn.addEventListener('click', ()=> onExport(false));
    if (xlsxBtn) xlsxBtn.addEventListener('click', ()=> onExport(true));
  }

  // wire after DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', wireExportButtons);
  } else {
    wireExportButtons();
  }
})();
</script>
</body>
</html>

