<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="asset-version" content="2025-10-23-5+show-archived+fix-filter" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Invoice Management — Show Archived (fixed)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --blue:#0b5cff; --navy:#08306b; --muted:#6b7280; --bg:#f5f7fb;
    --card:#ffffff; --success:#12b76a; --warn:#f59e0b; --danger:#ef4444;
    --approved-bg:#e6fffa;
    --pending-approval-bg:#eef6ff;
    --changes-requested-bg:#fff7ed;
  }
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
  .wrap{max-width:1200px;margin:28px auto;padding:16px}
  .card{background:var(--card);border-radius:10px;padding:12px;border:1px solid rgba(2,6,23,0.06);box-shadow:0 6px 20px rgba(12,20,40,0.04)}
  h2{margin:0 0 12px 0;color:var(--navy)}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .tool-btn{padding:8px 12px;border-radius:8px;border:1px solid #e6eef6;cursor:pointer;background:#fff;color:var(--navy);font-weight:700}
  .filter{padding:8px;border:1px solid #e6eef6;border-radius:8px;background:#fff}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px 8px;text-align:left;border-bottom:1px solid #f1f5f9;font-size:14px;vertical-align:middle}
  .table th{font-weight:700;color:var(--muted);font-size:12px}
  .status{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px;display:inline-block}
  .s-pending-review{background:#fff7ed;color:#9a5800}
  .s-pending-approval{background:var(--pending-approval-bg);color:#08306b}
  .s-approved-electronic{background:var(--approved-bg);color:#047857}
  .s-approved-physical{background:var(--approved-bg);color:#047857}
  .s-changes-requested{background:var(--changes-requested-bg);color:#9a5800}
  .s-rejected{background:#fff1f2;color:var(--danger)}
  .s-paid{background:#ecfdf5;color:var(--success)}
  .s-unpaid{background:#fff7ed;color:var(--navy)}
  .compact{font-size:13px;color:var(--muted)}
  .actions button{margin-left:6px;padding:6px 10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;cursor:pointer}
  .payment-primary{background:linear-gradient(90deg,var(--blue),#6ea8ff);color:#08306b;border:0;padding:6px 10px;border-radius:8px;cursor:pointer}
  .payment-secondary{background:#fff;border:1px solid #e6eef6;color:var(--navy);padding:6px 10px;border-radius:8px;cursor:pointer}
  th.amount,td.amount{width:140px;text-align:right;padding-right:18px}
  th.status,td.status{min-width:120px}
  th.approval-col,td.approval-col{width:160px;min-width:140px}
  .approval-col.hidden{display:none}
  .detail-panel{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:flex-end;padding:40px;pointer-events:none}
  .detail-card{width:880px;max-width:calc(100% - 48px);pointer-events:auto;background:#fff;border-radius:12px;padding:18px;border:1px solid rgba(2,6,23,0.06);box-shadow:0 30px 60px rgba(2,6,23,0.18);display:grid;grid-template-columns:1fr 360px;gap:18px}
  .detail-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn-primary{background:var(--blue);color:#fff}
  .btn-outline{ background:#fff; border:1px solid #e6eef6; color:var(--navy); text-decoration: none; }
  .field{display:flex;flex-direction:column;margin-bottom:8px}
  .input,.select,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef6;background:#fbfdff;font-family:inherit}
  .attachments{height:360px;background:#f8fafc;border-radius:8px;border:1px dashed #e6eef6;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  .line-items{border-top:1px solid #f1f5f9;margin-top:12px;padding-top:12px}
  .li-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #fbfdff}
  .audit{font-size:13px;color:var(--muted);margin-top:12px}
  .mark-completed { background: #e6f0ff; color: var(--navy); border: 1px solid #cfe0ff; font-weight:700; }
  .tag-picker .btn.btn-primary { background: #fff; color: var(--navy); border: 1px solid #e6eef6; }
  .tag-picker .filter { margin:0; padding:6px 8px; height:36px; }
  .tag-picker .btn { padding:6px 10px; height:36px; }
  @media(max-width:980px){ .detail-card{grid-template-columns:1fr} .attachments{height:220px} }
  .upload-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.35);display:none;align-items:center;justify-content:center;z-index:300}
  .upload-panel{width:720px;max-width:calc(100vw - 32px);background:#fff;border-radius:12px;box-shadow:0 24px 60px rgba(2,6,23,0.3);overflow:hidden;padding:16px}
  .upload-panel .h{font-weight:800}
  .upload-panel .input-file{display:block;width:100%;padding:12px;border:1px dashed #e6eef6;border-radius:8px;background:#fbfdff;cursor:pointer;text-align:center}
  .upload-panel .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .upload-panel .btn-primary{background:var(--blue);color:#fff}
  .upload-neutral{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:1px solid #e6eef6;background:#fff;color:var(--navy);font-weight:700;cursor:pointer;text-decoration:none;}
  .action-btn{background:#f3f4f6;border-radius:8px;padding:6px 10px;border:1px solid #e6eef6;cursor:pointer}
  .progress-bar{transition:width .3s linear}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:600}
  .modal{width:920px;background:#fff;border-radius:12px;padding:12px;box-shadow:0 20px 60px rgba(2,6,23,0.3);max-width:96vw;box-sizing:border-box;display:flex;flex-direction:column;max-height:calc(100vh - 48px);overflow:hidden}
  .modal-body{overflow:auto;padding-right:8px;flex:1 1 auto}
  .modal-footer{flex:0 0 auto;display:flex;justify-content:flex-end;gap:8px;padding-top:12px;border-top:1px solid #eef4ff;margin-top:12px}
  .split-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .split-row .small { font-size:12px;color:var(--muted) }
  .split-row input, .split-row select{padding:6px;border-radius:6px;border:1px solid #e6eef6}
  .split-amount{flex:0 0 110px;min-width:90px}
  .split-date{flex:0 0 130px;min-width:110px}
  .split-method{flex:0 0 140px;min-width:110px}
  .split-type{flex:0 0 140px;min-width:110px}
  .split-ref{flex:1 1 120px;min-width:80px}
  .split-actions{width:60px;text-align:center}
  .muted-inline{font-size:13px;color:var(--muted);margin-top:6px}
  @media (max-width:900px){ .modal { width: 92vw; } .modal-body > .grid { display:block; } .modal-body .grid > div { width:100%; } }
  @media (max-width:540px){
    .split-row input, .split-row select{ padding:6px 6px; font-size:13px; }
    .split-amount{ flex-basis:95px; }
  }
  .hidden{display:none}
  .small-muted{color:var(--muted);font-size:13px}
  .support-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .support-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px dashed #eef4ff;border-radius:8px;background:#fff}
  #showApprovalWrap .compact, #showArchivedWrap .compact { line-height:1; display:inline-flex; align-items:center; }
  .filter[type="checkbox"]{ width:18px; height:18px; padding:0; margin:0; }
  #categoryFilter { display: none !important; }
</style>
<!-- SheetJS for XLSX export -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div><h2>Invoice Management</h2></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="newUpload" class="tool-btn">Invoice Upload</button>
      <button id="bulkUpload" class="tool-btn">Receipt Upload</button>
      <button id="scanUpload" class="tool-btn">Payment Request</button>
      <button id="newManual" class="tool-btn">Advance Payment Request</button>
    </div>
  </div>

  <div class="card">
    <div class="toolbar" id="toolbarArea">
      <input id="q" class="filter" placeholder="Search by vendor, invoice #, amount or tag" style="width:240px" />
      <label class="compact">From</label><input id="dateFrom" type="date" class="filter" />
      <label class="compact">To</label><input id="dateTo" type="date" class="filter" />
      <select id="categoryFilter" class="filter">
        <option value="">All categories</option><option>Office Supplies</option><option>Travel</option><option>Rent</option><option>Entertainment</option><option>Consulting</option><option>Logistics</option><option>Maintenance</option>
      </select>

      <div id="approvalFilterWrap" style="display:none;align-items:center">
        <select id="statusFilter" class="filter">
          <option value="">All approval statuses</option>
          <option value="pending_review">Pending Review</option>
          <option value="pending_approval">Pending Approval</option>
          <option value="approved_electronic">Approved (Electronic)</option>
          <option value="approved_physical">Approved (Physical)</option>
          <option value="changes_requested">Changes Requested</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>

      <select id="paymentStatusFilter" class="filter">
        <option value="">All payment statuses</option>
        <option value="unpaid">Unpaid</option>
        <option value="paid">Paid</option>
      </select>

      <div id="showArchivedWrap" style="display:flex;align-items:center;gap:8px;margin-left:8px">
        <label class="compact">Show Archived</label>
        <input id="showArchived" type="checkbox" class="filter" />
      </div>

      <div id="showApprovalWrap" style="display:flex;align-items:center;gap:8px;margin-left:8px">
        <label class="compact" for="toggleApprovalCol" style="margin:0">Show Approval Column</label>
        <input id="toggleApprovalCol" type="checkbox" class="filter" />
      </div>

      <div style="flex:1"></div>
    </div>

    <table class="table" id="inboxTable" aria-label="Invoice management">
      <thead>
        <tr>
          <th scope="col" style="width:36px"><input id="selectAll" type="checkbox" /></th>
          <th scope="col">Vendor</th>
          <th scope="col">Invoice/Receipt #</th>
          <th scope="col">Date</th>
          <th scope="col" class="amount">Amount</th>
          <th scope="col" class="status">Status</th>
          <th scope="col" class="approval-col hidden">Approval</th>
          <th scope="col" style="width:320px">Actions</th>
        </tr>
      </thead>
      <tbody id="inboxBody"></tbody>
    </table>
  </div>
  </div>

<div class="wrap" style="margin-top:18px">
  <div class="card">
    <h3 style="margin:0 0 12px 0;color:var(--navy)">Export Payments</h3>
    <div class="toolbar" style="gap:12px">
     <label class="compact">Export type:</label>
  <select id="exportType" class="filter">
    <option value="all">All payment records</option>
    <option value="vendors">Vendor payments only</option>
    <option value="reimbursements">Employee reimbursements only</option>
  </select>

  <button id="exportCsvBtn" class="btn btn-primary">Export CSV</button>
  <button id="exportXlsxBtn" class="btn btn-outline">Download XLSX</button>

  <div style="flex:1"></div>
  <div class="muted-inline" style="margin-top:8px">Exported data will download as CSV or XLSX and include employee columns.</div>
</div>
  </div>
</div>

<!-- Payment modal backdrop centered (restored original layout and controls) -->
<div id="paymentModalBackdrop" class="modal-backdrop" aria-hidden="true" style="display:none;align-items:center;justify-content:center">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="paymentModalTitle">
    <div style="font-weight:700;margin-bottom:8px" id="paymentModalTitle">Settle invoice</div>

    <div id="paymentModalBody">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <label style="margin:0;font-weight:600">Mode</label>
        <label class="compact" style="margin:0 6px"><input id="singleMode" type="radio" name="payMode" checked /> Single</label>
        <label class="compact" style="margin:0 6px"><input id="splitMode" type="radio" name="payMode" /> Split</label>
      </div>

      <!-- Single payment area -->
      <div id="singlePaymentArea">
        <div class="field">
          <label class="compact">Type</label>
          <select id="payType" class="filter">
            <option value="pay">Pay vendor</option>
            <option value="reimburse">Reimburse employee</option>
          </select>
        </div>

        <div class="field hidden" id="employeeFields">
          <label class="compact">Employee ID</label>
          <input id="payEmployeeId" class="input" />
          <label class="compact" style="margin-top:8px">Employee name</label>
          <input id="payEmployeeName" class="input" />
        </div>

        <div class="field">
          <label class="compact">Amount</label>
          <input id="payAmount" class="input" type="number" step="0.01" min="0" />
          <div id="payRemaining" class="compact" style="margin-top:6px;color:var(--muted)"></div>
        </div>

        <div class="field">
          <label class="compact">Payment date</label>
          <input id="payDate" class="input" type="date" />
        </div>

        <div class="field">
          <label class="compact">Method</label>
          <select id="payMethod" class="filter">
            <option>Bank transfer</option>
            <option>Cash</option>
            <option>Card</option>
            <option>Other</option>
          </select>
        </div>

        <div class="field">
          <label class="compact">Reference</label>
          <input id="payRef" class="input" />
        </div>

        <div class="field">
          <label class="compact">Note</label>
          <textarea id="payNote" class="input" rows="3"></textarea>
        </div>

        <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
          <input id="schedulePayment" type="checkbox" />
          <label for="schedulePayment" class="compact" style="margin:0">Schedule payment (do not record now)</label>
        </div>
      </div>

      <!-- Split payment area -->
      <div id="splitPaymentArea" style="display:none">
        <div id="splitRows"></div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button id="addSplitRow" class="btn btn-outline" type="button">Add split line</button>
          <div class="muted-inline">Each line will create a separate payment record</div>
        </div>
        <div class="muted-inline" id="splitSummary" style="margin-top:10px"></div>

        <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <input id="scheduleSplit" type="checkbox" />
          <label for="scheduleSplit" class="compact" style="margin:0">Schedule split payments (do not record now)</label>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="payModalCancel" class="btn btn-outline">Cancel</button>
      <button id="payModalConfirm" class="btn btn-primary">Confirm payment</button>
    </div>
  </div>
</div>

<script>
/* Restored original demo invoices dataset (full set) */
let invoices = [
  { id:'inv-001', vendor:'ACME Supplies', number:'INV-1001', date:'2025-09-28', amount:1250.00, status:'pending_review', category:'Office Supplies', items:[{desc:'Paper',qty:10,price:12.5}], history:['Submitted by assistant • 2h ago'], directorAction:null, attachments:[] },
  { id:'inv-002', vendor:'Travel Co', number:'INV-1002', date:'2025-09-20', amount:420.00, status:'approved_electronic', category:'Travel', items:[{desc:'Taxi',qty:1,price:120},{desc:'Hotel',qty:1,price:300}], history:['Uploaded • Yesterday','Director approved electronically • 2025-10-02 09:15'], directorAction:{type:'approved_electronic',note:'Approved for payment',time:'2025-10-02 09:15'}, attachments:[], completionTag:'Sent to TRG', archivedCompleted:false },
  { id:'inv-003', vendor:'OfficeMax', number:'INV-1003', date:'2025-09-12', amount:210.00, status:'approved_electronic', paymentStatus:'unpaid', category:'Office Supplies', items:[{desc:'Staples',qty:5,price:42}], history:['Ready'], directorAction:null, attachments:[] },
  { id:'inv-004', vendor:'Catering Ltd', number:'INV-1004', date:'2025-10-01', amount:980.00, status:'rejected', category:'Entertainment', items:[{desc:'Lunch',qty:1,price:980}], history:['Rejected by reviewer • 1d ago'], directorAction:{type:'rejected',note:'Not eligible',time:'2025-10-02 09:00'}, attachments:[] },
  { id:'rec-001', vendor:'Cafe Corner', number:'REC-2025-1001', date:'2025-09-15', amount:48.75, status:'pending_review', category:'Travel', items:[{desc:'Team coffee & snacks',qty:1,price:48.75}], history:['Receipt uploaded • 2025-09-15 10:12'], directorAction:null, attachments:[{name:'CafeCorner-Receipt-09015.pdf',type:'Receipt'}] },
  { id:'rec-002', vendor:'TaxiFast', number:'REC-2025-1002', date:'2025-09-16', amount:22.40, status:'pending_review', category:'Travel', items:[{desc:'Airport taxi',qty:1,price:22.40}], history:['Receipt uploaded • 2025-09-16 08:45'], directorAction:null, attachments:[{name:'TaxiFast-09016.jpg',type:'Receipt'}] },
  { id:'inv-005', vendor:'Consulting LLC', number:'INV-1005', date:'2025-09-30', amount:3400.00, status:'approved_physical', category:'Consulting', items:[{desc:'Consulting fee',qty:1,price:3400}], history:['Submitted','Director approved (will sign physically) • 2025-10-02 10:30'], directorAction:{type:'approved_physical',note:'Will sign in person',time:'2025-10-02 10:30'}, attachments:[], completionTag:'Will be reimbursed on payday', archivedCompleted:false },
  { id:'inv-009', vendor:'Vendor A', number:'INV-2001', date:'2025-08-11', amount:500.00, status:'approved_electronic', category:'Office Supplies', items:[{desc:'Ink',qty:5,price:100}], history:['Director approved electronically • 2025-08-15','Assistant marked completed: Sent to TRG • 2025-08-16'], directorAction:{type:'approved_electronic',note:'OK'}, attachments:[], completionTag:'Sent to TRG', archivedCompleted:true },
  { id:'inv-010', vendor:'Vendor B', number:'INV-2002', date:'2025-07-20', amount:120.00, status:'approved_physical', category:'Travel', items:[{desc:'Taxi',qty:1,price:120}], history:['Director approved (physical) • 2025-07-25','Assistant marked completed: Transfer on Payday • 2025-07-26'], directorAction:{type:'approved_physical',note:'Will sign'}, attachments:[], completionTag:'Will be reimbursed on payday', archivedCompleted:true },
  { id:'inv-011', vendor:'Vendor C', number:'INV-2003', date:'2025-06-05', amount:60.00, status:'approved_electronic', category:'Office Supplies', items:[{desc:'Staples',qty:3,price:20}], history:['Director approved electronically • 2025-06-10','Assistant marked completed: archived • 2025-06-11'], directorAction:{type:'approved_electronic',note:'Approved'}, attachments:[], completionTag:'archived', archivedCompleted:true },
  { id:'inv-006', vendor:'Logistics Inc', number:'INV-1006', date:'2025-09-25', amount:1500.00, status:'pending_approval', category:'Logistics', items:[{desc:'Freight',qty:1,price:1500}], history:['Submitted'], directorAction:null, attachments:[] },
  { id:'inv-007', vendor:'Stationery Co', number:'INV-1007', date:'2025-10-02', amount:75.00, status:'changes_requested', category:'Office Supplies', items:[{desc:'Pens',qty:15,price:5}], history:['Uploaded • 1h ago','Director requested changes • 2025-10-02 11:00'], directorAction:{type:'changes_requested',note:'Please correct vendor code',time:'2025-10-02 11:00'}, attachments:[] },
  { id:'inv-008', vendor:'Maintenance Co', number:'INV-1008', date:'2025-10-03', amount:620.00, status:'pending_review', category:'Maintenance', items:[{desc:'Repair',qty:1,price:620}], history:['Submitted • 30m ago'], directorAction:null, attachments:[] }
];
// restore one rejected invoice
invoices.push({
  id: 'inv-REJ-001',
  vendor: 'Returned Supplies Co',
  number: 'INV-REJ-001',
  date: '2025-10-10',
  amount: 175.50,
  status: 'rejected',
  category: 'Office Supplies',
  items: [{ desc: 'Returned widget', qty: 1, price: 175.5 }],
  history: ['Uploaded • 2025-10-10', 'Rejected by director • 2025-10-10 14:00'],
  directorAction: { type: 'rejected', note: 'Incorrect pricing', time: '2025-10-10 14:00' },
  attachments: [],
  completionTag: 'Rejected',
  archivedCompleted: false,
  paymentRecords: [],
  balanceRemaining: 175.5,
  paymentStatus: 'unpaid'
});

// debug: confirm insertion and refresh UI
console.log('restored rejected invoice inserted', invoices.find(i => i.id === 'inv-REJ-001'));
if (typeof renderInbox === 'function') {
  try { renderInbox(); } catch(e) { /* renderInbox may not be defined yet during initial parse */ }
}

/* Seed demo paymentRecords so exports contain data and compute balances */
(function seedDemoPayments(){
  const demoMap = {
    'inv-009': [{ type:'pay', amount:250.00, method:'Bank transfer', ref:'TR-900', date:'2025-08-16', vendorName:'Vendor A' }],
    'inv-010': [{ type:'reimburse', amount:60.00, method:'Cash', ref:'CASH-331', date:'2025-07-26', vendorName:'Vendor B', employeeId:'E-9001', employeeName:'Tran Duc H' }],
    'inv-002': [{ type:'pay', amount:420.00, method:'Bank transfer', ref:'TR-420', date:'2025-09-21', vendorName:'Travel Co' }]
  };
  invoices.forEach(inv => {
    if(!inv.paymentRecords) inv.paymentRecords = [];
    if(demoMap[inv.id]){
      demoMap[inv.id].forEach(p => inv.paymentRecords.push(Object.assign({}, p)));
    }
    const paid = (inv.paymentRecords || []).reduce((s,r)=> s + (Number(r.amount) || 0), 0);
    inv.balanceRemaining = Math.max(0, Number(inv.amount || 0) - paid);
    if(inv.balanceRemaining <= 0){
      inv.paymentStatus = 'paid';
      inv.archivedCompleted = true;
    } else {
      if(typeof inv.paymentStatus === 'undefined') inv.paymentStatus = 'unpaid';
    }
  });
})();

const getById = id => document.getElementById(id);

function statusClass(s){
  if(s==='pending_review') return 's-pending-review';
  if(s==='pending_approval') return 's-pending-approval';
  if(s==='approved_electronic') return 's-approved-electronic';
  if(s==='approved_physical') return 's-approved-physical';
  if(s==='changes_requested') return 's-changes-requested';
  if(s==='rejected') return 's-rejected';
  return 's-pending-review';
}
function statusLabel(s){
  if(s==='pending_review') return 'Pending Review';
  if(s==='pending_approval') return 'Pending Approval';
  if(s==='approved_electronic') return 'Approved (Electronic)';
  if(s==='approved_physical') return 'Approved (Physical)';
  if(s==='changes_requested') return 'Changes Requested';
  if(s==='rejected') return 'Rejected';
  return s;
}
function paymentStatusClass(p){
  if(p==='paid') return 's-paid';
  return 's-unpaid';
}
function paymentStatusLabel(p){
  if(p==='paid') return 'Paid';
  return 'Unpaid';
}
function inDateRange(invDateISO, fromISO, toISO){
  if(!fromISO && !toISO) return true;
  const invD = new Date(invDateISO + 'T00:00:00');
  if(fromISO){ const fromD = new Date(fromISO + 'T00:00:00'); if(invD < fromD) return false; }
  if(toISO){ const toD = new Date(toISO + 'T23:59:59'); if(invD > toD) return false; }
  return true;
}

/* Render inbox (paid always visible; Show Archived checkbox shows archived invoices together with rejected invoices) */
function renderInbox(){
  const tbody = getById('inboxBody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const q = (getById('q') && getById('q').value.toLowerCase()) || '';
  const st = getById('statusFilter') ? getById('statusFilter').value : '';
  const payFilter = getById('paymentStatusFilter') ? getById('paymentStatusFilter').value : '';
  const cat = getById('categoryFilter') ? getById('categoryFilter').value : '';
  const from = getById('dateFrom') ? getById('dateFrom').value : '';
  const to = getById('dateTo') ? getById('dateTo').value : '';
  const showArchived = getById('showArchived') ? getById('showArchived').checked : false;
  const tagFilter = getById('completionTagFilter') ? (getById('completionTagFilter').value || '').trim() : '';
  const showApprovalCol = getById('toggleApprovalCol') ? getById('toggleApprovalCol').checked : false;

  // toggle approval column visibility on table header cells
  const ths = document.querySelectorAll('.approval-col');
  ths.forEach(h => { if(showApprovalCol) h.classList.remove('hidden'); else h.classList.add('hidden'); });

  invoices.forEach(inv => {
    if(typeof inv.balanceRemaining === 'undefined') inv.balanceRemaining = Number(inv.amount || 0);
    if(typeof inv.paymentRecords === 'undefined') inv.paymentRecords = [];
    if(typeof inv.scheduledPayments === 'undefined') inv.scheduledPayments = [];
    if(typeof inv.paymentStatus === 'undefined') inv.paymentStatus = 'unpaid';

    // Archive / rejected visibility rules
    // Always keep paid invoices visible.
    // Always show rejected invoices so user can act on them immediately.
    // When Show Archived is OFF: hide archived non-paid items.
    // When Show Archived is ON: include archived items as well.
    if (inv.paymentStatus === 'paid') {
      // allowed to show
    } else {
      if (inv.status === 'rejected') {
        // allow rejected invoices through so the user can Archive them
      } else {
        if (!showArchived) {
          if (inv.archivedCompleted) return; // hide archived non-paid rows
        } else {
          // Show Archived is ON: show archived items only (non-rejected already allowed above)
          if (!inv.archivedCompleted) return;
        }
      }
    }

    if (st && inv.status !== st) return;
    if (payFilter && inv.paymentStatus !== payFilter) return;
    if (cat && cat !== '' && inv.category !== cat) return;
    if (!inDateRange(inv.date, from, to)) return;

    if (q){
      const matches = (inv.vendor || '').toLowerCase().includes(q) ||
                      (inv.number || '').toLowerCase().includes(q) ||
                      String(inv.amount).includes(q) ||
                      ((inv.completionTag||'').toLowerCase().includes(q));
      if(!matches) return;
    }

    if (tagFilter){
      if ((inv.completionTag||'') !== tagFilter) return;
    }

    const tr = document.createElement('tr');
    tr.dataset.id = inv.id;

    const tdCheck = document.createElement('td'); const chk = document.createElement('input'); chk.type = 'checkbox'; chk.dataset.id = inv.id; tdCheck.appendChild(chk); tr.appendChild(tdCheck);
    const tdVendor = document.createElement('td'); tdVendor.textContent = inv.vendor || ''; tr.appendChild(tdVendor);
    const tdNumber = document.createElement('td'); tdNumber.textContent = inv.number || ''; tr.appendChild(tdNumber);
    const tdDate = document.createElement('td'); tdDate.textContent = inv.date || ''; tr.appendChild(tdDate);
    const tdAmount = document.createElement('td'); tdAmount.className = 'amount'; tdAmount.textContent = '$' + (Number(inv.amount || 0)).toFixed(2); tr.appendChild(tdAmount);

    // Status column shows only payment status
    const tdStatus = document.createElement('td'); tdStatus.className = 'status';
    const span = document.createElement('span');
    const pClass = paymentStatusClass(inv.paymentStatus);
    span.className = 'status ' + pClass;
    span.textContent = paymentStatusLabel(inv.paymentStatus);
    span.title = statusLabel(inv.status);
    tdStatus.appendChild(span);
    tr.appendChild(tdStatus);

    // Approval column (thin), hidden by default, toggled by checkbox
    const tdApproval = document.createElement('td'); tdApproval.className = 'approval-col compact';
    if(!getById('toggleApprovalCol').checked) tdApproval.classList.add('hidden');
    const aSpan = document.createElement('span');
    aSpan.className = 'compact';
    aSpan.textContent = statusLabel(inv.status);
    if(inv.directorAction && inv.directorAction.note) aSpan.title = inv.directorAction.note;
    tdApproval.appendChild(aSpan);
    tr.appendChild(tdApproval);

    const tdActions = document.createElement('td'); tdActions.className = 'compact actions';

    if(inv.archivedCompleted){
      if(inv.paymentStatus === 'paid' || (Number(inv.balanceRemaining||0) <= 0)){
        const done = document.createElement('div'); done.className='compact'; done.textContent = 'Settled';
        tdActions.appendChild(done);
      } else {
        const btnOpen = document.createElement('button'); btnOpen.className = 'btn btn-outline'; btnOpen.type = 'button'; btnOpen.textContent = 'Open';
        btnOpen.addEventListener('click', ()=> {
          window.location.href = 'Assistant_View_Approved_Invoice.html?id=' + encodeURIComponent(inv.id);
        });
        tdActions.appendChild(btnOpen);

        if(inv.employeeExpense || (inv.paymentStatus === 'unpaid' && inv.employeeExpense)){
          const btnReimb = document.createElement('button'); btnReimb.className='payment-primary'; btnReimb.type='button'; btnReimb.dataset.id=inv.id; btnReimb.textContent='Reimburse employee';
          btnReimb.addEventListener('click', (e)=> openSettleModal(inv.id,'reimburse'));
          tdActions.appendChild(btnReimb);
        } else {
          if(inv.paymentStatus === 'unpaid'){
            const btnPay = document.createElement('button'); btnPay.className='payment-primary'; btnPay.type='button'; btnPay.dataset.id=inv.id; btnPay.textContent='Pay';
            btnPay.addEventListener('click', (e)=> openSettleModal(inv.id,'pay'));
            tdActions.appendChild(btnPay);
          } else {
            const done = document.createElement('div'); done.className='compact'; done.textContent = 'Settled';
            tdActions.appendChild(done);
          }
        }
      }
    } else {
      const aOpen = document.createElement('a');
      aOpen.className = 'btn btn-outline open';
      let linkUrl = '';
      if (inv.status === 'pending_review' || inv.status === 'pending_approval') {
          linkUrl = 'Assistant_View_Invoice.html?id=' + inv.id;
      } else if (
          inv.status === 'approved_electronic' ||
          inv.status === 'approved_physical' ||
          inv.status === 'rejected'
      ) {
          linkUrl = 'Assistant_View_Approved_Invoice.html?id=' + inv.id;
      } else if (inv.status === 'changes_requested') {
          linkUrl = 'Assistant_View_Changed_Invoice.html?id=' + inv.id;
      } else {
          linkUrl = '#';
      }
      aOpen.href = linkUrl;
      aOpen.textContent = 'Open';
      tdActions.appendChild(aOpen);

      if(inv.status === 'pending_review'){
        const btnSubmit = document.createElement('button'); btnSubmit.className = 'btn btn-outline submit'; btnSubmit.type = 'button'; btnSubmit.dataset.id = inv.id; btnSubmit.textContent = 'Submit'; tdActions.appendChild(btnSubmit);
      }

      if(inv.status === 'changes_requested'){
        const btnResubmit = document.createElement('button'); btnResubmit.className = 'btn btn-outline resubmit-row'; btnResubmit.type = 'button'; btnResubmit.dataset.id = inv.id; btnResubmit.textContent = 'Resubmit'; tdActions.appendChild(btnResubmit);
      }

      if(inv.status === 'pending_review'){
        const btnDelete = document.createElement('button'); btnDelete.className = 'btn btn-outline delete'; btnDelete.type = 'button'; btnDelete.dataset.id = inv.id;
        btnDelete.style.color='var(--danger)'; btnDelete.style.borderColor='#fee2e2'; btnDelete.textContent='Delete'; tdActions.appendChild(btnDelete);
      }

      // For approved invoices show Pay and Archive buttons
      if (inv.status === 'approved_electronic' || inv.status === 'approved_physical') {
        const btnPay = document.createElement('button');
        btnPay.className = 'payment-primary';
        btnPay.type = 'button';
        btnPay.dataset.id = inv.id;
        btnPay.textContent = 'Pay';
        btnPay.addEventListener('click', () => openSettleModal(inv.id, inv.employeeExpense ? 'reimburse' : 'pay'));
        tdActions.appendChild(btnPay);

        // Archive button for approved invoices
        const btnArchive = document.createElement('button');
        btnArchive.className = 'btn mark-completed archive';
        btnArchive.type = 'button';
        btnArchive.dataset.id = inv.id;
        btnArchive.textContent = 'Archive';
        tdActions.appendChild(btnArchive);
      }

      // For rejected invoices, show Archive button when the invoice is not already archived
      if (inv.status === 'rejected' && !inv.archivedCompleted) {
        const btnArchive = document.createElement('button');
        btnArchive.className = 'btn mark-completed archive';
        btnArchive.type = 'button';
        btnArchive.dataset.id = inv.id;
        btnArchive.textContent = 'Archive';
        tdActions.appendChild(btnArchive);
      }
    }

    tr.appendChild(tdActions);
    tbody.appendChild(tr);
  });
}

/* Inline picker and completion-tag injection (same as original) */
function showInlineTagPicker(anchorBtn, invId){
  const existing = anchorBtn.parentElement.querySelector('.tag-picker');
  if(existing) return;

  const picker = document.createElement('span');
  picker.className = 'tag-picker';

  const sel = document.createElement('select');
  sel.className = 'filter';
  sel.innerHTML = '<option value="">Choose tag (optional)</option><option>Sent to TRG</option><option>Will be reimbursed on payday</option><option>Archived</option><option>Rejected</option>';

  const applyBtn = document.createElement('button');
  applyBtn.className = 'btn btn-primary';
  applyBtn.type = 'button';
  applyBtn.textContent = 'Apply';

  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'btn btn-outline';
  cancelBtn.type = 'button';
  cancelBtn.textContent = 'Cancel';

  picker.appendChild(sel);
  picker.appendChild(applyBtn);
  picker.appendChild(cancelBtn);

  anchorBtn.parentElement.appendChild(picker);

  setTimeout(()=> sel.focus(), 50);

  function removePicker(){
    if(picker && picker.parentElement) picker.remove();
  }

  applyBtn.addEventListener('click', () => {
    const tag = sel.value || '';
    const inv = invoices.find(i => i.id === invId);
    if(!inv) { removePicker(); return; }
    inv.completionTag = tag;
    inv.history = (inv.history||[]).concat([`Assistant marked completed${tag?': '+tag:''} • ${new Date().toLocaleString()}`]);
    inv.archivedCompleted = true;
    if(typeof inv.balanceRemaining === 'undefined') inv.balanceRemaining = Number(inv.amount||0);
    if(Number(inv.balanceRemaining || 0) <= 0){
      inv.paymentStatus = 'paid';
    } else {
      inv.paymentStatus = inv.paymentStatus || 'unpaid';
    }
    removePicker();
    renderInbox();
    alert('Marked completed (demo).');
  });

  cancelBtn.addEventListener('click', () => {
    removePicker();
  });

  function onDocClick(e){
    if(!picker.contains(e.target) && e.target !== anchorBtn){
      removePicker();
      document.removeEventListener('click', onDocClick);
    }
  }
  setTimeout(()=> document.addEventListener('click', onDocClick), 50);
}

function createCompletionTagSelect() {
  const sel = document.createElement('select');
  sel.id = 'completionTagFilter';
  sel.className = 'filter';
  sel.style.maxWidth = '200px';
  sel.innerHTML = '<option value="">Any completion tag</option>'
                + '<option>Sent to TRG</option>'
                + '<option>Will be reimbursed on payday</option>'
                + '<option>Rejected</option>'
                + '<option>Archived</option>';
  sel.addEventListener('input', () => renderInbox());
  return sel;
}
function removeInjectedCompletionTagSelect() {
  const existing = document.getElementById('completionTagFilter');
  if (existing && existing.parentElement && existing.parentElement.id === 'showArchivedWrap') {
    existing.remove();
  }
}

/* DOM ready wiring */
document.addEventListener('DOMContentLoaded', function(){
  const showWrap = document.getElementById('showArchivedWrap');
  const sc = document.getElementById('showArchived');

  removeInjectedCompletionTagSelect();

  function toggleInlineTagSelect() {
    removeInjectedCompletionTagSelect();
    if (sc && sc.checked) {
      const sel = createCompletionTagSelect();
      showWrap.appendChild(sel);
      setTimeout(()=>sel.focus(),100);
    }
    renderInbox();
  }

  if (sc) {
    sc.addEventListener('change', toggleInlineTagSelect);
    sc.addEventListener('input', toggleInlineTagSelect);
  }
  toggleInlineTagSelect();

  ['q','statusFilter','categoryFilter','dateFrom','dateTo','paymentStatusFilter','toggleApprovalCol'].forEach(id=>{
    const el = getById(id); if(el) el.addEventListener('input', ()=> renderInbox());
  });

  const newUpload = getById('newUpload');
  if (newUpload) newUpload.addEventListener('click', () => openUploadPanel('single'));

  const bulkUpload = getById('bulkUpload');
  if (bulkUpload) bulkUpload.addEventListener('click', () => openUploadPanel('bulk'));

  const scanUpload = getById('scanUpload');
  if (scanUpload) scanUpload.addEventListener('click', () => { window.location.href = 'payment-request.html'; });

  const newManualBtn = getById('newManual');
  if (newManualBtn) newManualBtn.addEventListener('click', () => { window.location.href = 'advance-payment.html'; });

  // Toggle Approval filter visibility with approval column checkbox
  (function wireApprovalFilterToggle(){
  const toggle = document.getElementById('toggleApprovalCol');
  const wrap = document.getElementById('approvalFilterWrap');
  const showApprovalWrap = document.getElementById('showApprovalWrap');
  if(!toggle || !wrap || !showApprovalWrap) return;

  // ensure wrap is placed after the checkbox so it appears to the right
  if (wrap.parentElement !== showApprovalWrap) {
    showApprovalWrap.appendChild(wrap);
  } else {
    // if already inside, force it to be last to the right
    showApprovalWrap.removeChild(wrap);
    showApprovalWrap.appendChild(wrap);
  }

  // styling for inline layout
  showApprovalWrap.style.display = 'flex';
  showApprovalWrap.style.alignItems = 'center';
  showApprovalWrap.style.gap = '8px';
  wrap.style.display = toggle.checked ? 'flex' : 'none';
  wrap.style.alignItems = 'center';

  try { renderInbox(); } catch(e){}

  toggle.addEventListener('change', () => {
    wrap.style.display = toggle.checked ? 'flex' : 'none';
    try { renderInbox(); } catch(e){}
  });
})();


  renderInbox();
});

/* delegated inbox actions */
getById('inboxBody').addEventListener('click', (e)=>{
  const openBtn = e.target.closest('.open'); if(openBtn){ return; }
  const submitBtn = e.target.closest('.submit'); if(submitBtn){
    const id = submitBtn.dataset.id; const inv = invoices.find(i=>i.id===id); if(!inv) return;
    if(inv.status === 'pending_review'){ inv.status='pending_approval'; inv.history=(inv.history||[]).concat([`Submitted to Director • ${new Date().toLocaleString()}`]); renderInbox(); alert(`Submitted ${inv.number} to Director (demo).`);} else alert('Submit ignored');
    return;
  }
  const resubmitRow = e.target.closest('.resubmit-row'); if(resubmitRow){
    const id = resubmitRow.dataset.id; const inv=invoices.find(i=>i.id===id); if(!inv) return;
    if(inv.status==='changes_requested'){ const note = prompt('Resubmission note (demo)','Corrected'); inv.history=(inv.history||[]).concat([`Resubmitted • ${new Date().toLocaleString()} • ${note}`]); inv.status='pending_approval'; renderInbox(); alert('Resubmitted (demo).');}
    return;
  }
  const deleteBtn = e.target.closest('.delete'); if(deleteBtn){
    const id = deleteBtn.dataset.id; const inv=invoices.find(i=>i.id===id); if(!inv) return; if(inv.status!=='pending_review'){ alert('Cannot delete'); return; } if(!confirm(`Delete ${inv.number}?`)) return; invoices=invoices.filter(i=>i.id!==id); renderInbox(); return;
  }

  // Archive buttons (applies to approved and rejected)
  const archiveBtn = e.target.closest('.archive');
  if(archiveBtn){
    const id = archiveBtn.dataset.id; const inv = invoices.find(i=>i.id===id); if(!inv) return;
    inv.completionTag = inv.completionTag || (inv.status === 'rejected' ? 'Rejected' : 'Archived');
    inv.history = (inv.history || []).concat([`${inv.status === 'rejected' ? 'Archived as rejected' : 'Archived'} • ${new Date().toLocaleString()}`]);
    inv.archivedCompleted = true;
    // Do NOT change paymentStatus when archiving
    renderInbox();
    alert((inv.status === 'rejected' ? 'Rejected invoice archived (demo).' : 'Invoice archived (demo).'));
    return;
  }

  const completedBtn = e.target.closest('.mark-completed'); if(completedBtn){
    const id = completedBtn.dataset.id; const inv=invoices.find(i=>i.id===id); if(!inv) return;
    if(inv.status === 'rejected'){
      inv.completionTag = 'Rejected';
      inv.history=(inv.history||[]).concat([`Archived as rejected • ${new Date().toLocaleString()}`]);
      inv.archivedCompleted = true;
      renderInbox();
      alert('Rejected invoice archived (demo).');
      return;
    }
    if(inv.status==='approved_electronic' || inv.status==='approved_physical'){
      showInlineTagPicker(completedBtn, id);
      return;
    }
    alert('Mark as Completed available only for approved or rejected invoices');
    return;
  }
});

/* upload panel helpers (minimal) */
function openUploadPanel(mode){
  const b = getById('uploadBackdrop');
  if(!b) { alert('Upload panel (demo)'); return; }
  b.style.display = 'flex';
  b.setAttribute('aria-hidden','false');
}
function closeUploadPanel(){ const b=getById('uploadBackdrop'); if(!b) return; b.style.display='none'; b.setAttribute('aria-hidden','true'); }

/* PAYMENT functionality (restored modal behavior) */
let _currentSettle = null;

/* Seed demo payments and export helpers are intentionally preserved from earlier file */
(function seedPaymentsForExports(){
  // already seeded above; function kept for compatibility
})();

function openSettleModal(invId, mode){
  const inv = invoices.find(i=>i.id===invId);
  if(!inv) return;
  _currentSettle = { id: invId, mode };
  const remaining = Number(inv.balanceRemaining || inv.amount || 0);

  const singleMode = getById('singleMode'); if(singleMode) singleMode.checked = true;
  const splitMode = getById('splitMode'); if(splitMode) splitMode.checked = false;
  if(getById('splitPaymentArea')) getById('splitPaymentArea').style.display = 'none';
  if(getById('singlePaymentArea')) getById('singlePaymentArea').style.display = 'block';

  if(getById('payAmount')) getById('payAmount').value = remaining.toFixed(2);
  if(getById('payType')) getById('payType').value = (mode === 'reimburse') ? 'reimburse' : (inv.employeeExpense ? 'reimburse' : 'pay');

  const empFields = getById('employeeFields');
  if(empFields){
    if(getById('payType').value === 'reimburse') empFields.classList.remove('hidden'); else empFields.classList.add('hidden');
  }

  if(getById('payEmployeeId')) getById('payEmployeeId').value = inv.employeeId || '';
  if(getById('payEmployeeName')) getById('payEmployeeName').value = inv.employeeName || '';

  if(getById('payRemaining')) getById('payRemaining').textContent = 'Remaining balance: $' + remaining.toFixed(2);
  if(getById('payDate')) getById('payDate').value = new Date().toISOString().slice(0,10);
  if(getById('payMethod')) getById('payMethod').value = 'Bank transfer';
  if(getById('payRef')) getById('payRef').value = '';
  if(getById('payNote')) getById('payNote').value = '';
  if(getById('schedulePayment')) getById('schedulePayment').checked = false;
  if(getById('scheduleSplit')) getById('scheduleSplit').checked = false;

  const splitRowsEl = getById('splitRows'); if(splitRowsEl) splitRowsEl.innerHTML = '';
  if(getById('splitSummary')) getById('splitSummary').textContent = '';

  const backdrop = getById('paymentModalBackdrop');
  if(!backdrop) return;
  backdrop.style.display = 'flex';
  backdrop.setAttribute('aria-hidden','false');
}

function closePaymentModal(){ const b = getById('paymentModalBackdrop'); if(!b) return; b.style.display = 'none'; b.setAttribute('aria-hidden','true'); _currentSettle = null; }

getById('payAmount') && getById('payAmount').addEventListener('input', ()=> {
  if(!_currentSettle) return;
  const inv = invoices.find(i=>i.id===_currentSettle.id);
  if(!inv) return;
  const typed = Number(getById('payAmount').value || 0);
  const max = Number(inv.balanceRemaining || inv.amount || 0);
  const remaining = Math.max(0, (max - (isNaN(typed)?0:typed)));
  if(getById('payRemaining')) getById('payRemaining').textContent = 'Remaining after this payment: $' + remaining.toFixed(2);
});

getById('payType') && getById('payType').addEventListener('change', ()=> {
  const t = getById('payType').value;
  const employeeFields = getById('employeeFields');
  if (t === 'reimburse') {
    if(employeeFields) employeeFields.classList.remove('hidden');
    if(getById('payModalConfirm')) getById('payModalConfirm').textContent = 'Confirm reimbursement';
  } else {
    if(employeeFields) employeeFields.classList.add('hidden');
    if(getById('payModalConfirm')) getById('payModalConfirm').textContent = 'Confirm payment';
  }
});

/* Split rows wiring */
(function wireSplitActions(){
  const addBtn = document.getElementById('addSplitRow');
  if(!addBtn) return;
  addBtn.addEventListener('click', ()=> {
    const container = document.getElementById('splitRows');
    if(!container) return;
    const row = document.createElement('div');
    row.className = 'split-row';
    row.innerHTML = `
      <input class="split-amount" type="number" step="0.01" min="0" placeholder="Amount" style="width:120px;padding:6px;border-radius:6px;border:1px solid #e6eef6" />
      <input class="split-date" type="date" style="padding:6px;border-radius:6px;border:1px solid #e6eef6" />
      <select class="split-method" style="padding:6px;border-radius:6px;border:1px solid #e6eef6">
        <option>Bank transfer</option><option>Cash</option><option>Card</option><option>Other</option>
      </select>
      <select class="split-type" style="padding:6px;border-radius:6px;border:1px solid #e6eef6">
        <option value="pay">Pay vendor</option><option value="reimburse">Reimburse employee</option>
      </select>
      <input class="split-ref" placeholder="Reference" style="padding:6px;border-radius:6px;border:1px solid #e6eef6" />
      <button class="btn btn-outline split-remove" type="button" style="margin-left:8px">Remove</button>
    `;
    container.appendChild(row);
    const amt = row.querySelector('.split-amount');
    if(amt) amt.addEventListener('input', updateSplitSummary);
    const rem = row.querySelector('.split-remove');
    if(rem) rem.addEventListener('click', ()=> { row.remove(); updateSplitSummary(); });
    updateSplitSummary();
  });
})();
function updateSplitSummary(){
  try {
    const rows = Array.from(document.querySelectorAll('#splitRows .split-row'));
    let total = 0;
    rows.forEach(r=>{
      const v = r.querySelector('.split-amount');
      if(!v) return;
      const n = parseFloat(v.value || 0) || 0;
      total += n;
    });
    const sumEl = document.getElementById('splitSummary');
    if(sumEl) sumEl.textContent = 'Split total: $' + total.toFixed(2);
  } catch(e){}
}

/* Wire payment modal confirm/cancel */
(function wirePaymentModal(){
  const cancel = document.getElementById('payModalCancel');
  const confirm = document.getElementById('payModalConfirm');
  if(cancel) cancel.addEventListener('click', ()=> {
    const pb = document.getElementById('paymentModalBackdrop');
    if(pb) { pb.style.display = 'none'; pb.setAttribute('aria-hidden','true'); }
    _currentSettle = null;
  });
  if(confirm) confirm.addEventListener('click', ()=> {
    if(!_currentSettle) { 
      const pb = document.getElementById('paymentModalBackdrop');
      if(pb) { pb.style.display = 'none'; pb.setAttribute('aria-hidden','true'); }
      return;
    }
    const inv = invoices.find(i=>i.id===_currentSettle.id);
    if(!inv){ alert('Invoice not found'); const pb = document.getElementById('paymentModalBackdrop'); if(pb){ pb.style.display='none'; pb.setAttribute('aria-hidden','true'); } _currentSettle=null; return; }

    if(document.getElementById('singleMode').checked){
      const type = (document.getElementById('payType') || {}).value || 'pay';
      const amount = parseFloat((document.getElementById('payAmount') || {}).value || 0) || 0;
      const method = (document.getElementById('payMethod') || {}).value || '';
      const ref = (document.getElementById('payRef') || {}).value || '';
      const date = (document.getElementById('payDate') || {}).value || new Date().toISOString().slice(0,10);
      const rec = { type, amount, method, ref, date };
      if(type === 'reimburse'){ rec.employeeId = (document.getElementById('payEmployeeId') || {}).value || ''; rec.employeeName = (document.getElementById('payEmployeeName') || {}).value || ''; }
      inv.paymentRecords = inv.paymentRecords || [];
      inv.paymentRecords.push(rec);
      inv.balanceRemaining = Math.max(0, (inv.balanceRemaining || inv.amount || 0) - amount);
      if(inv.balanceRemaining <= 0) {
        inv.paymentStatus = 'paid';
        inv.archivedCompleted = true;
      } else {
        inv.paymentStatus = 'unpaid';
      }
      inv.history = (inv.history || []).concat([`Payment recorded • ${new Date().toLocaleString()} • ${amount.toFixed(2)}`]);
      renderInbox();
      alert('Payment recorded (demo).');
      const pb = document.getElementById('paymentModalBackdrop'); if(pb){ pb.style.display='none'; pb.setAttribute('aria-hidden','true'); }
      _currentSettle = null;
      return;
    }

    const rows = Array.from(document.querySelectorAll('#splitRows .split-row'));
    if(rows.length === 0){ alert('Add at least one split line'); return; }
    rows.forEach(r=> {
      const amount = parseFloat((r.querySelector('.split-amount') || {}).value || 0) || 0;
      const date = (r.querySelector('.split-date') || {}).value || new Date().toISOString().slice(0,10);
      const method = (r.querySelector('.split-method') || {}).value || '';
      const type = (r.querySelector('.split-type') || {}).value || 'pay';
      const ref = (r.querySelector('.split-ref') || {}).value || '';
      const rec = { type, amount, method, ref, date };
      inv.paymentRecords = inv.paymentRecords || [];
      inv.paymentRecords.push(rec);
      inv.balanceRemaining = Math.max(0, (inv.balanceRemaining || inv.amount || 0) - amount);
    });
    if(inv.balanceRemaining <= 0) {
      inv.paymentStatus = 'paid';
      inv.archivedCompleted = true;
    } else {
      inv.paymentStatus = 'unpaid';
    }
    inv.history = (inv.history || []).concat([`Split payments recorded • ${new Date().toLocaleString()}`]);
    renderInbox();
    alert('Split payments recorded (demo).');
    const pb = document.getElementById('paymentModalBackdrop'); if(pb){ pb.style.display='none'; pb.setAttribute('aria-hidden','true'); }
    _currentSettle = null;
  });
})();

/* EXPORT helpers (kept from earlier) */
(function(){
  const EXPORT_COLUMNS = [
    { key: 'invoiceId', header: 'Invoice ID' },
    { key: 'invoiceNumber', header: 'Invoice Number' },
    { key: 'invoiceDate', header: 'Invoice Date' },
    { key: 'invoiceAmount', header: 'Invoice Amount' },
    { key: 'balanceRemaining', header: 'Balance Remaining' },
    { key: 'paymentType', header: 'Payment Type' },
    { key: 'amount', header: 'Amount' },
    { key: 'method', header: 'Method' },
    { key: 'ref', header: 'Reference' },
    { key: 'paymentDate', header: 'Payment Date' },
    { key: 'vendorName', header: 'Vendor Name' },
    { key: 'employeeId', header: 'Employee ID' },
    { key: 'employeeName', header: 'Employee Name' }
  ];

  function buildExportRows(){
    const rows = [];
    (invoices || []).forEach(inv => {
      (inv.paymentRecords || []).forEach(p => {
        rows.push({
          invoiceId: inv.id || '',
          invoiceNumber: inv.number || '',
          invoiceDate: inv.date || '',
          invoiceAmount: inv.amount || 0,
          balanceRemaining: inv.balanceRemaining || 0,
          paymentType: p.type || '',
          amount: p.amount || 0,
          method: p.method || '',
          ref: p.ref || '',
          paymentDate: p.date || '',
          vendorName: inv.vendor || '',
          employeeId: p.employeeId || '',
          employeeName: p.employeeName || ''
        });
      });
    });
    return rows;
  }

  function toCsv(rows, columns){
    const esc = v => {
      if (v === null || typeof v === 'undefined') return '';
      const s = String(v);
      if (s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    };
    const header = columns.map(c => esc(c.header)).join(',');
    const lines = rows.map(r => columns.map(c => esc(r[c.key])).join(','));
    return [header].concat(lines).join('\r\n');
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 5000);
  }

  function downloadCsv(text, filename){
    const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
    downloadBlob(blob, filename);
  }

  function downloadXlsx(rows, columns, filename){
    try {
      const sheetRows = rows.map(r => {
        const out = {};
        columns.forEach(c => out[c.header] = r[c.key]);
        return out;
      });
      const ws = XLSX.utils.json_to_sheet(sheetRows, { skipHeader: false });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Payments');
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });
      downloadBlob(blob, filename);
    } catch (err) {
      alert('XLSX export failed: ' + (err && err.message ? err.message : 'unknown'));
    }
  }

  function wireExportButtons(){
    const csvBtn = document.getElementById('exportCsvBtn');
    const xlsxBtn = document.getElementById('exportXlsxBtn');
    const getType = ()=> (document.getElementById('exportType') || {}).value || 'all';

    function makeFilename(ext){
      const now = new Date(); const pad = n => String(n).padStart(2,'0');
      return `payments-export-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.${ext}`;
    }

    function onExport(isXlsx){
      const type = getType();
      const all = buildExportRows();
      let filtered = all;
      if (type === 'vendors') filtered = all.filter(r => r.paymentType === 'pay');
      if (type === 'reimbursements') filtered = all.filter(r => r.paymentType === 'reimburse');
      if (!filtered.length) { alert('No records to export for the selected filter.'); return; }

      if (isXlsx) {
        downloadXlsx(filtered, EXPORT_COLUMNS, makeFilename('xlsx'));
      } else {
        const csv = toCsv(filtered, EXPORT_COLUMNS);
        downloadCsv(csv, makeFilename('csv'));
      }
    }

    if (csvBtn) csvBtn.addEventListener('click', ()=> onExport(false));
    if (xlsxBtn) xlsxBtn.addEventListener('click', ()=> onExport(true));
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', wireExportButtons);
  } else {
    wireExportButtons();
  }
})();

/* final render */
try { renderInbox(); } catch(e){ console.warn('final render failed', e); }
</script>
</body>
</html>


