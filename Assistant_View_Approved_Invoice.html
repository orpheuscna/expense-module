<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistant — Invoice View</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --blue:#0b5cff; --navy:#08306b; --muted:#6b7280; --bg:#f5f7fb;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    .panel {width:100vw; height:100vh; max-width:1600px; margin:0 auto; background:#fff; display:grid; grid-template-columns:40% 60%; overflow:hidden; box-shadow:0 24px 60px rgba(2,6,23,0.08)}
    .panel .viewer{background:#f8fafc; display:flex; flex-direction:column}
    .panel header{padding:12px 16px;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .fld {margin-bottom:8px}
    .fld label{display:block;font-size:12px;color:var(--muted);font-weight:700;margin-bottom:6px}
    .fld input, .fld select, .fld textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef6;font-size:14px}
    .action-btn{background:#f3f4f6;border-radius:8px;padding:6px 10px;border:1px solid #e6eef6;cursor:pointer}
    .upload-neutral{background:transparent;color:var(--navy);padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;border:0}
    table.line-items{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px}
    table.line-items th, table.line-items td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    table.line-items th{background:#fbfdff;font-weight:700;color:var(--muted)}
    .support-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .support-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px dashed #eef4ff;border-radius:8px;background:#fff}
    .support-item .meta { display:flex; flex-direction:column; gap:4px; }
    .support-item .meta > .filename { font-size:13px; font-weight:700; } 
    .support-item .meta > .filename.contract { font-size:12px; font-weight:700; color:#0f172a; } 
    .support-item .tag { font-size:12px; color:var(--muted); }
    .totals-block{display:flex;justify-content:flex-end;margin-top:12px;align-items:flex-end}
    .totals-inner{width:320px}
    .small-muted{color:var(--muted);font-size:13px}
    .btn { padding:8px 12px; border-radius:8px; border: none; cursor:pointer; font-size:14px; }
    .btn-primary { background: var(--blue); color: #fff; }
    .btn-secondary { background:#e2e8f0; }
    .link-docs { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .link-docs select { flex:1; padding:10px; border-radius:8px; border:1px solid #e6eef6; font-size:14px; }

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:800}
    .modal{width:720px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(2,6,23,0.3);max-height:84vh;overflow:auto}
    .modal h3{margin:0 0 8px 0}
    .doc-viewer { border:1px solid #e6eef6; border-radius:8px; background:#fff; padding:12px; max-height:64vh; overflow:auto; }
    .doc-actions { display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }

    /* document preview styles */
    .pr,.po,.contract{font-size:14px;line-height:1.45;color:#0f172a}
    .pr .header,.po .header,.contract .c-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .pr .box{border:1px solid #eef4ff;padding:10px;border-radius:8px;background:#fbfdff}
    .po .box{border:1px solid #eef4ff;padding:10px;border-radius:8px;background:#fffaf6}
    .contract .box{border:1px solid #eef4ff;padding:10px;border-radius:8px;background:#fff}
    .signature-area{margin-top:16px;border-top:1px dashed #e6eef6;padding-top:10px;display:flex;justify-content:space-between;align-items:center}

    .inline-tag-picker{display:inline-flex;gap:8px;align-items:center;padding:6px;border-radius:8px;border:1px solid #e6eef6;background:#fff;margin-left:8px}
    .inline-tag-picker select{padding:6px;border-radius:6px;border:1px solid #e6eef6;height:36px}
    .inline-tag-picker button{padding:6px 10px;border-radius:6px}

    @media(max-width:1000px){ .panel{grid-template-columns:1fr} .panel .viewer{height:36vh} .modal{width:92%} }

    /* viewer content flex-scroll fix */
    .viewer > div[style*="padding:12px"] { flex: 1 1 auto; min-height: 0; overflow: auto; }
  </style>
</head>
<body>

<div class="panel" role="main" aria-labelledby="panelTitle">
  <!-- Left: Viewer -->
  <div class="viewer" role="region" aria-label="Invoice preview">
    <header>
      <div>
        <strong id="panelTitle">INV-xxxx</strong>
        <div class="small" id="panelStatus" style="margin-top:4px">Needs Assistant action</div>
      </div>
      <div>
        <button id="closeBtn" class="action-btn" title="Back to dashboard">Close</button>
      </div>
    </header>

    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;" class="viewer-body">
      <div id="docViewer" class="sample-invoice" aria-label="Sample invoice">
        <div style="font-weight:700" class="si-h" id="viewVendor">Vendor — Invoice</div>

        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <div><strong>Invoice</strong> <span id="viewInvId">INV-xxxx</span></div>
          <div><strong>Date</strong> <span id="viewDate">YYYY-MM-DD</span></div>
        </div>

        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <div><strong>Bill To</strong><br/><span id="viewBillTo">Company</span></div>
          <div><strong>Due</strong> <span id="viewDue">YYYY-MM-DD</span></div>
        </div>

        <div style="margin-top:12px;font-weight:700">Items</div>

        <table style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead>
            <tr style="background:#fbfdff">
              <th style="text-align:left;padding:8px">Description</th>
              <th style="padding:8px;width:80px">Qty</th>
              <th style="padding:8px;width:120px">Unit</th>
              <th style="padding:8px;width:120px">Tax</th>
              <th style="padding:8px;width:140px">Amount</th>
            </tr>
          </thead>
          <tbody id="viewTableBody"></tbody>
        </table>

        <div class="totals-block" style="margin-top:12px">
          <div class="totals-inner" id="viewTotals">
            <div style="display:flex;justify-content:space-between"><div class="small-muted">Subtotal</div><div style="font-weight:800" id="viewSubtotal">$0.00</div></div>
            <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="small-muted">Total Tax</div><div style="font-weight:800" id="viewTotalTax">$0.00</div></div>
            <div style="border-top:1px solid #eef4ff;margin-top:8px;padding-top:8px;display:flex;justify-content:space-between"><div style="font-weight:900">Grand Total</div><div style="font-weight:900" id="viewGrandTotal">$0.00</div></div>
          </div>
        </div>

        <div style="margin-top:18px;font-size:13px;color:var(--muted)" id="viewAttached">Attached: </div>
      </div>

      <div style="display:flex;gap:8px">
        <button class="action-btn viewer-btn" data-zoom="-1">Zoom −</button>
        <button class="action-btn viewer-btn" data-zoom="1">Zoom +</button>
        <button class="action-btn" id="downloadDoc">Download</button>
      </div>
    </div>
  </div>

  <!-- Right: Details -->
  <div style="padding:0;display:flex;flex-direction:column;overflow:auto" role="region" aria-label="Invoice details">
    <div style="padding:12px 16px;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;flex-direction:column">
        <div style="font-weight:800" id="detailInvId">INV-xxxx</div>
        <div class="small" id="detailSubtitle">Uploaded: YYYY-MM-DD • Vendor</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="markCompletedBtn" class="btn btn-primary">Mark as Completed</button>
      </div>
    </div>

    <div style="padding:12px 16px;display:flex;flex-direction:column;gap:10px;flex:1 1 auto;min-height:0;overflow:auto">
      <div class="fld">
        <label for="vendorFld">Vendor</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="vendorFld" value="" />
        </div>
      </div>

      <div style="display:flex;gap:10px">
        <div style="flex:1" class="fld">
          <label for="dateFld">Invoice Date</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="dateFld" type="date" />
          </div>
        </div>

        <div style="width:180px" class="fld">
          <label for="totalFld">Total</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="totalFld" />
          </div>
        </div>
      </div>

      <div class="fld">
        <label for="categoryFld">Category</label>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="categoryFld">
            <option>Office Supplies</option><option>Travel</option><option>Rent</option><option>Entertainment</option><option>Tools</option><option>Laptops</option>
          </select>
        </div>
      </div>

      <div>
        <div style="font-weight:700;margin-bottom:6px">Line items</div>
        <table class="line-items" id="lineItemsTable" aria-label="Line items table">
          <thead>
            <tr><th style="width:40%">Description</th><th style="width:12%">Quantity</th><th style="width:16%">Unit Price</th><th style="width:16%">Tax</th><th style="width:16%">Amount after Tax</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="small">Totals recalc automatically when quantity or unit price changes</div>
          <div style="display:flex;gap:8px">
            <button id="addLine" class="action-btn">Add line</button>
            <button id="autoCalc" class="upload-neutral">Recalculate</button>
          </div>
        </div>

        <div class="totals-block" id="totalsBlock">
          <div class="totals-inner">
            <div style="display:flex;justify-content:space-between;padding:6px 0"><div class="small-muted">Subtotal</div><div id="subtotalDisplay" style="font-weight:800">$0.00</div></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0"><div class="small-muted">Total Tax</div><div id="totalTaxDisplay" style="font-weight:800">$0.00</div></div>
            <div style="border-top:1px solid #eef4ff;margin-top:6px;padding-top:8px;display:flex;justify-content:space-between"><div style="font-weight:800">Grand Total</div><div id="grandTotalDisplay" style="font-weight:900">$0.00</div></div>
            <div id="totalMismatch" style="color:#b45309;font-size:13px;margin-top:6px;display:none">Calculated total does not match invoice total. Please verify.</div>
          </div>
        </div>
      </div>

      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700;margin-bottom:6px">Supporting documents</div>
          <div class="small" style="font-size:13px">Select type or link system document</div>
        </div>

        <div class="link-docs" style="margin-top:6px">
          <select id="paymentTypeSelect">
            <option value="">Select type</option>
            <option value="Payment Request">Payment Request</option>
            <option value="Payment Order">Payment Order</option>
            <option value="Other documents">Other documents</option>
          </select>

          <input id="paymentUploadSelect" type="file" multiple />

          <button id="attachTypeBtn" class="action-btn">Attach</button>
        </div>

        <div class="link-docs" style="margin-top:8px">
          <select id="linkedDocSelect">
            <option value="">Select existing system document to link</option>
            <option value="Contract_2025_01.pdf|Other documents">Contract_2025_01.pdf</option>
            <option value="PO_2025_234.pdf|Other documents">PO_2025_234.pdf</option>
            <option value="Approval_Email_2025_09_15.pdf|Other documents">Approval_Email_2025_09_15.pdf</option>
            <option value="PaymentRequest_TEMPLATE.pdf|Payment Request">PaymentRequest_TEMPLATE.pdf</option>
            <option value="PaymentOrder_TEMPLATE.pdf|Payment Order">PaymentOrder_TEMPLATE.pdf</option>
          </select>
          <button id="linkDocBtn" class="action-btn">Link</button>
        </div>

        <div style="margin-top:8px">
          <div class="small-muted">Use the selector to upload or link documents already in the system (no re-upload needed).</div>
        </div>

        <div class="support-list" id="supportList" aria-live="polite" style="margin-top:8px"></div>
      </div>

      <div class="fld">
        <label for="notesFld">Notes</label>
        <textarea id="notesFld" rows="3"></textarea>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
        <button id="closePanelFooter" class="action-btn">Close</button>
        <button id="markCompletedFooter" class="btn btn-primary">Mark as Completed</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal for previewing support files (Assistant) -->
<div id="modalPreview" class="modal-backdrop" role="dialog" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="previewTitle">
    <h3 id="previewTitle">Document preview</h3>
    <div class="doc-viewer" id="previewContent" tabindex="0">
      Loading...
    </div>

    <div style="margin-top:12px">
      <div id="previewMeta" class="small-muted"></div>
    </div>

    <div class="doc-actions" style="margin-top:12px">
      <button id="previewDownload" class="action-btn">Download</button>
      <button id="previewRemove" class="action-btn">Remove</button>
      <button id="previewClose" class="action-btn">Close</button>
    </div>
  </div>
</div>
<script>
// Universal final patch: attach handlers after DOM is ready
document.addEventListener('DOMContentLoaded', function(){
  // Safe getters
  const goBack = () => { window.location.href = 'Assistant_Invoice_Management.html'; };

  // Close buttons
  const closeBtn = document.getElementById('closeBtn');
  if (closeBtn) closeBtn.addEventListener('click', goBack);
  const closePanelFooter = document.getElementById('closePanelFooter');
  if (closePanelFooter) closePanelFooter.addEventListener('click', goBack);

  // Save / Submit / Draft buttons
  const saveDraft = document.getElementById('saveDraft');
  if (saveDraft) saveDraft.addEventListener('click', function(){ alert('Draft saved (demo).'); goBack(); });

  const submitToDirector = document.getElementById('submitToDirector');
  if (submitToDirector) submitToDirector.addEventListener('click', function(){
    alert('Submitted to Director (demo).');
    const status = document.getElementById('panelStatus'); if(status) status.textContent='Submitted';
    goBack();
  });

  const submitPanel = document.getElementById('submitPanel');
  if (submitPanel) submitPanel.addEventListener('click', function(){
    // keep existing checks if present, then redirect
    try {
      if (typeof computeTotals === 'function' && typeof parseMoney === 'function') {
        const { grand } = computeTotals();
        const invoiceTotal = parseMoney(document.getElementById('totalFld')?.value || '');
        if (Math.abs((invoiceTotal||0) - (grand||0)) > 0.005) {
          if(!confirm('Calculated grand total differs from invoice total. Submit anyway?')) return;
        }
      }
    } catch(e){ /* ignore and continue */ }
    alert('Submitted to Director (demo).');
    const status = document.getElementById('panelStatus'); if(status) status.textContent='Submitted';
    goBack();
  });

  // Mark as Completed (buttons) - immediate redirect after marking
  const markCompletedBtn = document.getElementById('markCompletedBtn');
  if (markCompletedBtn) markCompletedBtn.addEventListener('click', function(){
    // If your file uses showCompletionChooser / inline picker, it will redirect after apply.
    // This fallback marks completed immediately and returns.
    alert('Marked as completed (demo).');
    goBack();
  });
  const markCompletedFooter = document.getElementById('markCompletedFooter');
  if (markCompletedFooter) markCompletedFooter.addEventListener('click', function(){
    alert('Marked as completed (demo).');
    goBack();
  });

  // Resubmit / Resubmit button (changes requested)
  const resubmitBtn = document.querySelector('.resubmit-row');
  if (resubmitBtn) resubmitBtn.addEventListener('click', function(){ alert('Resubmitted (demo).'); goBack(); });

  // If your page uses an inline tag picker with an Apply button created dynamically,
  // patch the global function that creates it so Apply also redirects.
  if (typeof showInlineTagPicker === 'function') {
    const orig = showInlineTagPicker;
    window.showInlineTagPicker = function(anchorBtn, invId) {
      orig(anchorBtn, invId);
      // find the dynamically created Apply button and hook redirect when clicked
      setTimeout(() => {
        const parent = anchorBtn.parentElement;
        if (!parent) return;
        const applyBtn = parent.querySelector('.tag-picker .btn.btn-primary, .inline-tag-picker .apply-tag, .inline-tag-picker .btn.btn-primary');
        if (applyBtn) {
          applyBtn.addEventListener('click', function(){ setTimeout(goBack, 120); }, { once: true });
        }
      }, 60);
    };
  }
});
</script>

<script>
  const INVOICE_DB = {
    'INV-2025-001': {
      id: 'INV-2025-001',
      vendor: 'ACME Supplies Co.',
      date: '2025-10-25',
      due: '2025-11-24',
      billTo: 'HR Department\nCompany XYZ\n123 Nguyen Van Linh',
      total: '$330.00',
      subtitle: 'Uploaded: 2025-10-26 • Vendor: ACME Supplies Co.',
      lines: [
        { desc:'Printer paper A4', qty:10, unit:7.50, tax:0.00 },
        { desc:'Toner cartridge', qty:3, unit:75.00, tax:0.00 }
      ],
      attached: [
        { name: 'Contract_2025_01.pdf', type: 'Other documents' },
        { name: 'PaymentRequest_INV-2025-001.pdf', type: 'Payment Request' },
        { name: 'PaymentOrder_INV-2025-001.pdf', type: 'Payment Order' }
      ],
      notes: 'Missing delivery slip',
      status: 'approved_electronic',
      directorAction: { type: 'approved_electronic', note: '