<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="asset-version" content="2025-10-15-1" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistant — Invoice View</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --blue:#0b5cff; --navy:#08306b; --muted:#6b7280; --bg:#f5f7fb;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    .panel {width:100vw; height:100vh; max-width:1600px; margin:0 auto; background:#fff; display:grid; grid-template-columns:40% 60%; overflow:hidden; box-shadow:0 24px 60px rgba(2,6,23,0.08)}
    .panel .viewer{background:#f8fafc; display:flex; flex-direction:column}
    .panel header{padding:12px 16px;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .fld {margin-bottom:8px}
    .fld label{display:block;font-size:12px;color:var(--muted);font-weight:700;margin-bottom:6px}
    .fld input, .fld select, .fld textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef6;font-size:14px}
    .action-btn{background:#f3f4f6;border-radius:8px;padding:6px 10px;border:1px solid #e6eef6;cursor:pointer}
    .upload-neutral{background:transparent;color:var(--navy);padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;border:0}
    table.line-items{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px}
    table.line-items th, table.line-items td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    table.line-items th{background:#fbfdff;font-weight:700;color:var(--muted)}
    .support-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .support-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px dashed #eef4ff;border-radius:8px;background:#fff}
    .support-item .meta { display:flex; flex-direction:column; gap:4px; }
    .support-item .meta > .filename { font-size:13px; font-weight:700; } 
    .support-item .meta > .filename.contract { font-size:12px; font-weight:700; color:#0f172a; } 
    .support-item .tag { font-size:12px; color:var(--muted); }
    .totals-block{display:flex;justify-content:flex-end;margin-top:12px;align-items:flex-end}
    .totals-inner{width:320px}
    .small-muted{color:var(--muted);font-size:13px}
    .btn { padding:8px 12px; border-radius:8px; border: none; cursor:pointer; font-size:14px; }
    .btn-primary { background: var(--blue); color: #fff; }
    .btn-secondary { background:#e2e8f0; }
    .link-docs { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .link-docs select { flex:1; padding:10px; border-radius:8px; border:1px solid #e6eef6; font-size:14px; }

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:800}
    .modal{width:720px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(2,6,23,0.3);max-height:84vh;overflow:auto}
    .modal h3{margin:0 0 8px 0}
    .doc-viewer { border:1px solid #e6eef6; border-radius:8px; background:#fff; padding:12px; max-height:64vh; overflow:auto; }
    .doc-actions { display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }

    /* document preview styles */
    .pr,.po,.contract{font-size:14px;line-height:1.45;color:#0f172a}
    .pr .header,.po .header,.contract .c-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .pr .box{border:1px solid #eef4ff;padding:10px;border-radius:8px;background:#fbfdff}
    .po .box{border:1px solid #eef4ff;padding:10px;border-radius:8px;background:#fffaf6}
    .contract .box{border:1px solid #eef4ff;padding:10px;border-radius:8px;background:#fff}
    .signature-area{margin-top:16px;border-top:1px dashed #eef4ff;padding-top:10px;display:flex;justify-content:space-between;align-items:center}

    .inline-tag-picker{display:inline-flex;gap:8px;align-items:center;padding:6px;border-radius:8px;border:1px solid #e6eef6;background:#fff;margin-left:8px}
    .inline-tag-picker select{padding:6px;border-radius:6px;border:1px solid #e6eef6;height:36px}
    .inline-tag-picker button{padding:6px 10px;border-radius:6px}

    /* Reimburse image preview block (keeps style consistent) */
    .reimburse-image-card {
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:10px;
      border-radius:8px;
      background: #fff;
      border: 1px solid #e6eef6;
      margin-top:8px;
    }
    .reimburse-image-card img {
      width:120px;
      height:auto;
      object-fit:cover;
      border-radius:6px;
      flex:0 0 120px;
      box-shadow: 0 2px 6px rgba(2,6,23,0.06);
    }
    .reimburse-image-card .meta { display:block; min-width:0; flex:1 1 auto; }
    .reimburse-image-card .meta .title { font-weight:700; color:#0f172a; margin-bottom:6px; font-size:14px; }
    .reimburse-image-card .meta .desc { color:var(--muted); font-size:13px; line-height:1.3; white-space:normal; }

    @media(max-width:1000px){ .panel{grid-template-columns:1fr} .panel .viewer{height:36vh} .modal{width:92%} }

    /* viewer content flex-scroll fix */
    .viewer > div[style*="padding:12px"] { flex: 1 1 auto; min-height: 0; overflow: auto; }
  </style>
</head>
<body>

<div class="panel" role="main" aria-labelledby="panelTitle">
  <!-- Left: Viewer -->
  <div class="viewer" role="region" aria-label="Invoice preview">
    <header>
      <div>
        <strong id="panelTitle">INV-xxxx</strong>
        <div class="small" id="panelStatus" style="margin-top:4px">Approved</div>
      </div>
      <div>
        <button id="closeBtn" class="action-btn" title="Back to dashboard">Close</button>
      </div>
    </header>

    <div style="padding:12px; display:flex; flex-direction:column; gap:10px;" class="viewer-body">
      <div id="docViewer" class="sample-invoice" aria-label="Sample invoice">
        <div style="font-weight:700" class="si-h" id="viewVendor">Vendor — Invoice</div>

        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <div><strong>Invoice</strong> <span id="viewInvId">INV-xxxx</span></div>
          <div><strong>Date</strong> <span id="viewDate">YYYY-MM-DD</span></div>
        </div>

        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <div><strong>Bill To</strong><br/><span id="viewBillTo">Company</span></div>
          <div><strong>Due</strong> <span id="viewDue">YYYY-MM-DD</span></div>
        </div>

        <div style="margin-top:12px;font-weight:700">Items</div>

        <table style="width:100%;border-collapse:collapse;margin-top:8px">
          <thead>
            <tr style="background:#fbfdff">
              <th style="text-align:left;padding:8px">Description</th>
              <th style="padding:8px;width:80px">Qty</th>
              <th style="padding:8px;width:120px">Unit</th>
              <th style="padding:8px;width:120px">Tax</th>
              <th style="padding:8px;width:140px">Amount</th>
            </tr>
          </thead>
          <tbody id="viewTableBody"></tbody>
        </table>

        <div class="totals-block" style="margin-top:12px">
          <div class="totals-inner" id="viewTotals">
            <div style="display:flex;justify-content:space-between"><div class="small-muted">Subtotal</div><div style="font-weight:800" id="viewSubtotal">$0.00</div></div>
            <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="small-muted">Total Tax</div><div style="font-weight:800" id="viewTotalTax">$0.00</div></div>
            <div style="border-top:1px solid #eef4ff;margin-top:8px;padding-top:8px;display:flex;justify-content:space-between"><div style="font-weight:900">Grand Total</div><div style="font-weight:900" id="viewGrandTotal">$0.00</div></div>
          </div>
        </div>

        <div style="margin-top:18px;font-size:13px;color:var(--muted)" id="viewAttached">Attached: </div>
      </div>

      <div style="display:flex;gap:8px">
        <button class="action-btn viewer-btn" data-zoom="-1">Zoom −</button>
        <button class="action-btn viewer-btn" data-zoom="1">Zoom +</button>
        <button class="action-btn" id="downloadDoc">Download</button>
      </div>
    </div>
  </div>

  <!-- Right: Details -->
  <div style="padding:0;display:flex;flex-direction:column;overflow:auto" role="region" aria-label="Invoice details">
    <div style="padding:12px 16px;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;flex-direction:column">
        <div style="font-weight:800" id="detailInvId">INV-2025-001</div>
        <div class="small" id="detailSubtitle">Uploaded: 2025-10-26 • Vendor: ACME Supplies Co.</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="markCompletedBtn" class="btn btn-primary">Mark as Completed</button>
      </div>
    </div>

    <div style="padding:12px 16px;display:flex;flex-direction:column;gap:10px;flex:1 1 auto;min-height:0;overflow:auto">
      <div class="fld">
        <label for="vendorFld">Vendor</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="vendorFld" value="ACME Supplies Co." />
        </div>
      </div>

      <div style="display:flex;gap:10px">
        <div style="flex:1" class="fld">
          <label for="dateFld">Invoice Date</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="dateFld" type="date" value="2025-10-25" />
          </div>
        </div>

        <div style="width:180px" class="fld">
          <label for="totalFld">Total</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="totalFld" value="$330.00" />
          </div>
        </div>
      </div>

      <div class="fld">
        <label for="categoryFld">Category</label>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="categoryFld">
            <option>Office Supplies</option><option>Travel</option><option>Rent</option><option>Entertainment</option><option>Tools</option><option>Laptops</option>
          </select>
        </div>
      </div>

      <div>
        <div style="font-weight:700;margin-bottom:6px">Line items</div>
        <table class="line-items" id="lineItemsTable" aria-label="Line items table">
          <thead>
            <tr><th style="width:40%">Description</th><th style="width:12%">Quantity</th><th style="width:16%">Unit Price</th><th style="width:16%">Tax</th><th style="width:16%">Amount after Tax</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="small">Totals recalc automatically when quantity or unit price changes</div>
          <div style="display:flex;gap:8px">
            <button id="addLine" class="action-btn">Add line</button>
            <button id="autoCalc" class="upload-neutral">Recalculate</button>
          </div>
        </div>

        <div class="totals-block" id="totalsBlock">
          <div class="totals-inner">
            <div style="display:flex;justify-content:space-between;padding:6px 0"><div class="small-muted">Subtotal</div><div id="subtotalDisplay" style="font-weight:800">$0.00</div></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0"><div class="small-muted">Total Tax</div><div id="totalTaxDisplay" style="font-weight:800">$0.00</div></div>
            <div style="border-top:1px solid #eef4ff;margin-top:6px;padding-top:8px;display:flex;justify-content:space-between"><div style="font-weight:800">Grand Total</div><div id="grandTotalDisplay" style="font-weight:900">$0.00</div></div>
            <div id="totalMismatch" style="color:#b45309;font-size:13px;margin-top:6px;display:none">Calculated total does not match invoice total. Please verify.</div>
          </div>
        </div>
      </div>

      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700;margin-bottom:6px">Supporting documents</div>
          <div class="small" style="font-size:13px">Select type or link system document</div>
        </div>

        <div class="link-docs" style="margin-top:6px">
          <select id="paymentTypeSelect">
            <option value="">Select type</option>
            <option value="Payment Request">Payment Request</option>
            <option value="Payment Order">Payment Order</option>
            <option value="Other documents">Other documents</option>
          </select>

          <input id="paymentUploadSelect" type="file" multiple />

          <button id="attachTypeBtn" class="action-btn">Attach</button>
        </div>

        <div class="link-docs" style="margin-top:8px">
          <select id="linkedDocSelect">
            <option value="">Select existing system document to link</option>
            <option value="Contract_2025_01.pdf|Other documents">Contract_2025_01.pdf</option>
            <option value="PO_2025_234.pdf|Other documents">PO_2025_234.pdf</option>
            <option value="Approval_Email_2025_09_15.pdf|Other documents">Approval_Email_2025_09_15.pdf</option>
            <option value="PaymentRequest_TEMPLATE.pdf|Payment Request">PaymentRequest_TEMPLATE.pdf</option>
            <option value="PaymentOrder_TEMPLATE.pdf|Payment Order">PaymentOrder_TEMPLATE.pdf</option>
          </select>
          <button id="linkDocBtn" class="action-btn">Link</button>
        </div>

        <div style="margin-top:8px">
          <div class="small-muted">Use the selector to upload or link documents already in the system (no re-upload needed).</div>
        </div>

        <div class="support-list" id="supportList" aria-live="polite" style="margin-top:8px"></div>
      </div>

      <!-- Payment destination control (added) -->
      <div style="margin-top:10px; border-top:1px solid #eef4ff; padding-top:10px;">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-weight:700">Payment destination</div>
          <label class="small" style="display:inline-flex;align-items:center;gap:6px;margin:0;">
            <input id="payVendorRd" name="payDest" type="radio" value="vendor" />
            <span>Pay vendor</span>
          </label>
          <label class="small" style="display:inline-flex;align-items:center;gap:6px;margin:0;">
            <input id="reimburseRd" name="payDest" type="radio" value="reimburse" />
            <span>Reimburse employee</span>
          </label>
        </div>

        <div id="employeeBlock" style="margin-top:10px; display:none; gap:8px; align-items:center;">
          <div style="display:flex;gap:8px;width:100%;align-items:flex-start">
            <div style="flex:0 0 180px" class="fld">
              <label for="employeeIdFld">Employee ID</label>
              <input id="employeeIdFld" />
            </div>
            <div style="flex:1" class="fld">
              <label for="employeeNameFld">Employee name</label>
              <input id="employeeNameFld" placeholder="Who should receive reimbursement" />
            </div>
          </div>
        </div>
      </div>

      <div class="fld">
        <label for="notesFld">Notes</label>
        <textarea id="notesFld" rows="3">Missing delivery slip</textarea>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
        <button id="closePanelFooter" class="action-btn">Close</button>
        <button id="markCompletedFooter" class="btn btn-primary">Mark as Completed</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal for previewing support files (Assistant) -->
<div id="modalPreview" class="modal-backdrop" role="dialog" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="previewTitle">
    <h3 id="previewTitle">Document preview</h3>
    <div class="doc-viewer" id="previewContent" tabindex="0">
      Loading...
    </div>

    <div style="margin-top:12px">
      <div id="previewMeta" class="small-muted"></div>
    </div>

    <div class="doc-actions" style="margin-top:12px">
      <button id="previewDownload" class="action-btn">Download</button>
      <button id="previewRemove" class="action-btn">Remove</button>
      <button id="previewClose" class="action-btn">Close</button>
    </div>
  </div>
</div>

<script>
  // In-memory sample data
  const INVOICE_DB = {
    'INV-2025-001': {
      id: 'INV-2025-001',
      vendor: 'ACME Supplies Co.',
      date: '2025-10-25',
      due: '2025-11-24',
      billTo: 'HR Department\nCompany XYZ\n123 Nguyen Van Linh',
      total: '$330.00',
      subtitle: 'Uploaded: 2025-10-26 • Vendor: ACME Supplies Co.',
      lines: [
        { desc:'Printer paper A4', qty:10, unit:7.50, tax:0.00 },
        { desc:'Toner cartridge', qty:3, unit:75.00, tax:0.00 }
      ],
      attached: [
        { name: 'Contract_2025_01.pdf', type: 'Other documents' },
        { name: 'PaymentRequest_INV-2025-001.pdf', type: 'Payment Request' },
        { name: 'PaymentOrder_INV-2025-001.pdf', type: 'Payment Order' }
      ],
      notes: 'Missing delivery slip',
      status: 'approved_electronic',
      directorAction: { type: 'approved_electronic', note: 'Approved electronically by Director on 2025-10-27' },
      // set payment destination and employee values for this approved invoice
      paymentDestination: 'reimburse',
      employeeId: 'EMP-4092',
      employeeName: 'Linh Tran'
    }
  };

  // helpers
  function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[ch]); }
  function parseMoney(v){ if(typeof v!=='string') v = String(v||''); v = v.replace(/[^\d.\-]/g,''); const n=parseFloat(v); return Number.isFinite(n)?n:0; }
  function fmtMoney(n){ return '$'+Number(n||0).toFixed(2); }

  // populate and wire up interactions
  document.addEventListener('DOMContentLoaded', function(){
    const inv = INVOICE_DB['INV-2025-001'];
    if(inv){
      document.getElementById('panelTitle').textContent = inv.id;
      document.getElementById('detailInvId').textContent = inv.id;
      document.getElementById('detailSubtitle').textContent = inv.subtitle;
      document.getElementById('vendorFld').value = inv.vendor;
      document.getElementById('dateFld').value = inv.date;
      document.getElementById('totalFld').value = inv.total;
      document.getElementById('viewInvId').textContent = inv.id;
      document.getElementById('viewDate').textContent = inv.date;
      document.getElementById('viewDue').textContent = inv.due || '—';
      document.getElementById('viewVendor').textContent = inv.vendor + ' — Invoice';
      document.getElementById('viewBillTo').innerText = inv.billTo || '';
      document.getElementById('notesFld').value = inv.notes || '';

      // view table rows
      const vtb = document.getElementById('viewTableBody'); vtb.innerHTML='';
      inv.lines.forEach(l=>{
        const amt = (l.qty * l.unit) + (l.tax || 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="padding:8px">${escapeHtml(l.desc)}</td><td style="padding:8px">${l.qty}</td><td style="padding:8px">$${l.unit.toFixed(2)}</td><td style="padding:8px">$${(l.tax||0).toFixed(2)}</td><td style="padding:8px">$${amt.toFixed(2)}</td>`;
        vtb.appendChild(tr);
      });

      // detail editable lines
      const tbody = document.querySelector('#lineItemsTable tbody'); tbody.innerHTML='';
      inv.lines.forEach(l=>{
        const amt = (l.qty * l.unit) + (l.tax || 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input value="${escapeHtml(l.desc)}"></td><td><input value="${l.qty}"></td><td><input value="$${l.unit.toFixed(2)}"></td><td><input value="$${(l.tax||0).toFixed(2)}"></td><td><input value="$${amt.toFixed(2)}"></td>`;
        tbody.appendChild(tr);
      });
      computeTotals();
    }

    // Payment destination wiring and defaults (set reimburse selected and prefill employee)
    const payVendor = document.getElementById('payVendorRd');
    const reimburse = document.getElementById('reimburseRd');
    const employeeBlock = document.getElementById('employeeBlock');
    const empIdFld = document.getElementById('employeeIdFld');
    const empNameFld = document.getElementById('employeeNameFld');

    function showEmployeeBlock(show){
      if(!employeeBlock) return;
      employeeBlock.style.display = show ? 'block' : 'none';
    }

    // default from INVOICE_DB if present
    if(inv && inv.paymentDestination === 'reimburse'){
      if(reimburse) reimburse.checked = true;
      if(payVendor) payVendor.checked = false;
      showEmployeeBlock(true);
    } else {
      if(payVendor) payVendor.checked = true;
      if(reimburse) reimburse.checked = false;
      showEmployeeBlock(false);
    }

    // prefill employee fields with INVOICE_DB values or demo values
    if(empIdFld) empIdFld.value = (inv && inv.employeeId) ? inv.employeeId : 'EMP-4092';
    if(empNameFld) empNameFld.value = (inv && inv.employeeName) ? inv.employeeName : 'Linh Tran';

    if(payVendor){
      payVendor.addEventListener('change', function(){
        if(payVendor.checked) showEmployeeBlock(false);
      });
    }
    if(reimburse){
      reimburse.addEventListener('change', function(){
        if(reimburse.checked){
          showEmployeeBlock(true);
          if(empNameFld) empNameFld.focus();
        }
      });
    }

    // wire basic controls (close, mark completed)
    const goBack = ()=>{ window.location.href = 'Assistant_Invoice_Management.html'; };
    document.getElementById('closeBtn')?.addEventListener('click', goBack);
    document.getElementById('closePanelFooter')?.addEventListener('click', goBack);
    document.getElementById('markCompletedBtn')?.addEventListener('click', function(){ alert('Marked as completed (demo).'); goBack(); });
    document.getElementById('markCompletedFooter')?.addEventListener('click', function(){ alert('Marked as completed (demo).'); goBack(); });

    // viewer actions
    document.querySelectorAll('.viewer-btn').forEach(b=>{
      b.addEventListener('click', function(){
        const z = Number(this.dataset.zoom||0);
        const iframe = document.getElementById('pdfFrame');
        if(iframe){
          const h = parseInt(iframe.style.height||'300',10) + (z*50);
          iframe.style.height = Math.max(120, h) + 'px';
        }
      });
    });
    document.getElementById('downloadDoc')?.addEventListener('click', function(){ alert('Download (demo).'); });

    // support actions (demo)
    document.getElementById('attachTypeBtn')?.addEventListener('click', function(){ alert('Attach (demo)'); });
    document.getElementById('linkDocBtn')?.addEventListener('click', function(){ alert('Link (demo)'); });
    document.getElementById('supportList')?.addEventListener('click', function(e){
      const rm = e.target.closest('.remove-support');
      if(rm){ if(confirm('Remove this document?')) rm.closest('.support-item')?.remove(); }
    });

    // preview modal controls
    document.getElementById('previewClose')?.addEventListener('click', function(){ document.getElementById('modalPreview').style.display='none'; });
    document.getElementById('previewDownload')?.addEventListener('click', function(){ alert('Download (demo)'); });
    document.getElementById('previewRemove')?.addEventListener('click', function(){ if(confirm('Remove?')) document.getElementById('modalPreview').style.display='none'; });

    // add line / recalc
    document.getElementById('addLine')?.addEventListener('click', function(){
      const tbody = document.querySelector('#lineItemsTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = '<td><input value=""></td><td><input value="1"></td><td><input value="$0.00"></td><td><input value="$0.00"></td><td><input value="$0.00"></td>';
      tbody.appendChild(tr); computeTotals();
    });
    document.getElementById('autoCalc')?.addEventListener('click', function(){
      const rows = document.querySelectorAll('#lineItemsTable tbody tr');
      rows.forEach(r=>{
        try{
          const q = parseMoney(r.cells[1].querySelector('input').value);
          const up = parseMoney(r.cells[2].querySelector('input').value);
          const tax = parseMoney(r.cells[3].querySelector('input').value);
          const amt = (q * up) + tax;
          r.cells[4].querySelector('input').value = '$' + amt.toFixed(2);
        }catch(e){}
      });
      computeTotals();
      alert('Line totals recalculated (demo).');
    });

    // compute totals on input changes
    document.querySelector('#lineItemsTable')?.addEventListener('input', debounce(function(){ computeTotals(); }, 300));
  });

  // computeTotals function (keeps totals in sync)
  function computeTotals(){
    const rows = document.querySelectorAll('#lineItemsTable tbody tr');
    let subtotal=0, totalTax=0, grand=0;
    rows.forEach(r=>{
      try{
        const q = parseMoney(r.cells[1].querySelector('input').value);
        const up = parseMoney(r.cells[2].querySelector('input').value);
        const tax = parseMoney(r.cells[3].querySelector('input').value);
        const before = q * up;
        const after = before + tax;
        subtotal += before;
        totalTax += tax;
        grand += after;
      }catch(e){}
    });
    document.getElementById('subtotalDisplay').textContent = fmtMoney(subtotal);
    document.getElementById('totalTaxDisplay').textContent = fmtMoney(totalTax);
    document.getElementById('grandTotalDisplay').textContent = fmtMoney(grand);
    document.getElementById('viewSubtotal').textContent = fmtMoney(subtotal);
    document.getElementById('viewTotalTax').textContent = fmtMoney(totalTax);
    document.getElementById('viewGrandTotal').textContent = fmtMoney(grand);
    return { subtotal, totalTax, grand };
  }

  // Simple debounce
  function debounce(fn, ms){
    let t;
    return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), ms); };
  }
</script>
</body>
</html>

```
